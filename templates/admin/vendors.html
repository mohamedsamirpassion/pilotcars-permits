{% extends 'base.html' %}

{% block title %}Pilot Management - Pilot Cars & Permits Admin{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2><i class="fas fa-users-cog me-2"></i>Pilot Management</h2>
          <p class="text-muted">Manage registered pilot accounts and pilot car services</p>
        </div>
        <div>
          <a href="/admin" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card bg-success text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h5>{{ vendors | selectattr('is_suspended', 'equalto', false) | list | length }}</h5>
              <small>Active Pilots</small>
            </div>
            <i class="fas fa-user-check fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-danger text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h5>{{ vendors | selectattr('is_suspended', 'equalto', true) | list | length }}</h5>
              <small>Suspended Pilots</small>
            </div>
            <i class="fas fa-user-slash fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-info text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h5>{{ vendors | length }}</h5>
              <small>Total Pilots</small>
            </div>
            <i class="fas fa-users fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pilots Table -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          {% if vendors %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Pilot Details</th>
                  <th>Contact Info</th>
                  <th>Status</th>
                  <th>Activity</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for vendor in vendors %}
                <tr class="{% if vendor.is_suspended %}table-danger{% endif %}">
                  <td>
                    <div>
                      <strong>{{ vendor.company_name }}</strong>
                      <br><small class="text-muted">ID: #{{ vendor.id }}</small>
                      <br><small class="text-muted">Registered: {{ vendor.created_at.strftime('%m/%d/%Y') }}</small>
                    </div>
                  </td>
                  <td>
                    <div>
                      <i class="fas fa-envelope text-info me-1"></i>
                      <a href="mailto:{{ vendor.email }}">{{ vendor.email }}</a><br>
                      {% if vendor.phone_number %}
                        <i class="fas fa-phone text-success me-1"></i>
                        <a href="tel:{{ vendor.phone_number }}">{{ vendor.phone_number }}</a>
                      {% else %}
                        <span class="text-muted">No phone</span>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    {% if vendor.is_suspended %}
                      <span class="badge bg-danger">Suspended</span>
                    {% else %}
                      <span class="badge bg-success">Active</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="small">
                      {% set active_locations = vendor.vendor_locations | selectattr('expires_at', 'gt', moment().utcnow()) | list %}
                      <strong>{{ active_locations | length }}</strong> Active Locations<br>
                      <strong>{{ vendor.vendor_locations | length }}</strong> Total Locations<br>
                      {% if vendor.vendor_locations %}
                        Last: {{ vendor.vendor_locations[-1].created_at.strftime('%m/%d/%Y') }}
                      {% else %}
                        <span class="text-muted">No locations shared</span>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    <div class="btn-group-vertical btn-group-sm" role="group">
                      {% if not vendor.is_suspended %}
                        <button type="button" class="btn btn-warning btn-sm" 
                                onclick="suspendUser({{ vendor.id }}, '{{ vendor.company_name }}')" 
                                title="Suspend Pilot">
                          <i class="fas fa-ban me-1"></i>Suspend
                        </button>
                      {% else %}
                        <button type="button" class="btn btn-info btn-sm" 
                                onclick="unsuspendUser({{ vendor.id }}, '{{ vendor.company_name }}')" 
                                title="Unsuspend Pilot">
                          <i class="fas fa-check-circle me-1"></i>Unsuspend
                        </button>
                      {% endif %}
                      
                      <button type="button" class="btn btn-outline-primary btn-sm" 
                              onclick="viewVendor({{ vendor.id }})" title="View Details">
                        <i class="fas fa-eye me-1"></i>Details
                      </button>
                      
                      <button type="button" class="btn btn-outline-success btn-sm" 
                              onclick="viewLocations({{ vendor.id }})" title="View Locations">
                        <i class="fas fa-map-marker-alt me-1"></i>Locations
                      </button>
                      
                      {% if session.is_super_admin %}
                      <button type="button" class="btn btn-outline-warning btn-sm" 
                              onclick="resetVendorPassword({{ vendor.id }}, '{{ vendor.company_name }}')" 
                              title="Reset Password">
                        <i class="fas fa-key me-1"></i>Reset Password
                      </button>
                      {% endif %}
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center py-5">
            <i class="fas fa-users-cog text-muted" style="font-size: 4rem;"></i>
            <h4 class="mt-3 text-muted">No registered pilots yet</h4>
            <p class="text-muted">Pilot registrations will appear here</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Pilot Details Modal -->
<div class="modal fade" id="vendorModal" tabindex="-1" aria-labelledby="vendorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="vendorModalLabel">Pilot Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="vendorModalBody">
        <!-- Pilot details will be loaded here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Password Reset Modal -->
<div class="modal fade" id="passwordResetModal" tabindex="-1" aria-labelledby="passwordResetModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="passwordResetModalLabel">
          <i class="fas fa-key me-2"></i>Reset Pilot Password
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Warning:</strong> This will reset the pilot's password. They will need to use the new temporary password to log in.
        </div>
        
        <div class="mb-3">
          <strong>Pilot:</strong> <span id="resetPilotName"></span><br>
          <strong>Type:</strong> <span class="badge bg-info">Pilot</span>
        </div>
        
        <form id="passwordResetForm">
          <div class="mb-3">
            <label for="newPassword" class="form-label">
              <i class="fas fa-lock me-1"></i>New Temporary Password
            </label>
            <input type="password" class="form-control" id="newPassword" required minlength="6"
                   placeholder="Enter temporary password (min 6 characters)">
            <div class="form-text">Pilot will need to change this password after logging in.</div>
          </div>
          
          <div class="mb-3">
            <label for="confirmPassword" class="form-label">
              <i class="fas fa-lock me-1"></i>Confirm Password
            </label>
            <input type="password" class="form-control" id="confirmPassword" required minlength="6"
                   placeholder="Confirm temporary password">
          </div>
          
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="confirmReset" required>
            <label class="form-check-label" for="confirmReset">
              I understand this will reset the pilot's password and they will need to use the new temporary password.
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" onclick="confirmPasswordReset()">
          <i class="fas fa-key me-2"></i>Reset Password
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Pilot data for JavaScript functions
const vendors = [
  {% for vendor in vendors %}
  {
    id: {{ vendor.id }},
    company_name: "{{ vendor.company_name }}",
    email: "{{ vendor.email }}",
    phone_number: "{{ vendor.phone_number or '' }}",
    created_at: "{{ vendor.created_at.strftime('%m/%d/%Y %I:%M %p') }}",
    is_suspended: {{ vendor.is_suspended|lower }},
    locations_count: {{ vendor.vendor_locations|length }},
    active_locations_count: {{ vendor.vendor_locations | selectattr('expires_at', 'gt', moment().utcnow()) | list | length }}
  },
  {% endfor %}
];

function suspendUser(userId, companyName) {
  if (confirm(`Are you sure you want to suspend ${companyName}? They will not be able to access their account.`)) {
    fetch(`/admin/suspend-user/${userId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert(data.message);
        location.reload();
      } else {
        alert('Error: ' + data.error);
      }
    })
    .catch(error => {
      alert('Error: ' + error);
    });
  }
}

function unsuspendUser(userId, companyName) {
  if (confirm(`Are you sure you want to unsuspend ${companyName}?`)) {
    fetch(`/admin/unsuspend-user/${userId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert(data.message);
        location.reload();
      } else {
        alert('Error: ' + data.error);
      }
    })
    .catch(error => {
      alert('Error: ' + error);
    });
  }
}

function viewVendor(vendorId) {
  const vendor = vendors.find(v => v.id === vendorId);
  if (!vendor) {
    alert('Vendor not found');
    return;
  }
  
  const modalBody = document.getElementById('vendorModalBody');
  modalBody.innerHTML = `
    <div class="row">
      <div class="col-md-6">
        <h6>Vendor Information</h6>
        <table class="table table-sm">
          <tr>
            <td><strong>Vendor ID:</strong></td>
            <td>#${vendor.id}</td>
          </tr>
          <tr>
            <td><strong>Company Name:</strong></td>
            <td>${vendor.company_name}</td>
          </tr>
          <tr>
            <td><strong>Registration Date:</strong></td>
            <td>${vendor.created_at}</td>
          </tr>
          <tr>
            <td><strong>Status:</strong></td>
            <td>${vendor.is_suspended ? '<span class="badge bg-danger">Suspended</span>' : 
                   '<span class="badge bg-success">Active</span>'}</td>
          </tr>
        </table>
      </div>
      
      <div class="col-md-6">
        <h6>Contact & Activity</h6>
        <table class="table table-sm">
          <tr>
            <td><strong>Email:</strong></td>
            <td><a href="mailto:${vendor.email}">${vendor.email}</a></td>
          </tr>
          <tr>
            <td><strong>Phone:</strong></td>
            <td>${vendor.phone_number ? '<a href="tel:' + vendor.phone_number + '">' + vendor.phone_number + '</a>' : '<span class="text-muted">Not provided</span>'}</td>
          </tr>
          <tr>
            <td><strong>Active Locations:</strong></td>
            <td>${vendor.active_locations_count}</td>
          </tr>
          <tr>
            <td><strong>Total Locations:</strong></td>
            <td>${vendor.locations_count}</td>
          </tr>
        </table>
      </div>
    </div>
  `;
  
  new bootstrap.Modal(document.getElementById('vendorModal')).show();
}

function viewLocations(vendorId) {
  // Redirect to vendor locations page with filter
  window.open(`/admin/vendor-locations?vendor_id=${vendorId}`, '_blank');
}

// Password Reset Functions
let currentResetPilotId = null;

function resetVendorPassword(pilotId, pilotName) {
  currentResetPilotId = pilotId;
  
  // Set pilot info in modal
  document.getElementById('resetPilotName').textContent = pilotName;
  
  // Clear form
  document.getElementById('passwordResetForm').reset();
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('passwordResetModal'));
  modal.show();
}

function confirmPasswordReset() {
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  const confirmCheckbox = document.getElementById('confirmReset').checked;
  
  // Validation
  if (!newPassword || newPassword.length < 6) {
    alert('Password must be at least 6 characters long');
    return;
  }
  
  if (newPassword !== confirmPassword) {
    alert('Passwords do not match');
    return;
  }
  
  if (!confirmCheckbox) {
    alert('Please confirm that you understand the implications of resetting the password');
    return;
  }
  
  // Show loading state
  const resetButton = document.querySelector('#passwordResetModal .btn-warning');
  const originalText = resetButton.innerHTML;
  resetButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Resetting...';
  resetButton.disabled = true;
  
  // Send reset request
  fetch(`/admin/reset-customer-password/${currentResetPilotId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      new_password: newPassword
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Show success message
      alert(data.message + '\n\nPlease provide the pilot with their new temporary password securely.');
      
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('passwordResetModal'));
      modal.hide();
      
      // Reset form
      document.getElementById('passwordResetForm').reset();
      currentResetPilotId = null;
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('An error occurred while resetting the password. Please try again.');
  })
  .finally(() => {
    // Restore button state
    resetButton.innerHTML = originalText;
    resetButton.disabled = false;
  });
}

// Clear form when modal is hidden
document.getElementById('passwordResetModal').addEventListener('hidden.bs.modal', function () {
  document.getElementById('passwordResetForm').reset();
  currentResetPilotId = null;
});
</script>
{% endblock %} 