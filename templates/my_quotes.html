{% extends 'base.html' %}

{% block title %}My Quotes - My PEVO{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2><i class="fas fa-file-invoice-dollar me-2"></i>My Quotes</h2>
          <p class="text-muted mb-0">View and manage your saved quotes</p>
        </div>
        <div>
          <a href="{{ url_for('get_quote') }}" class="btn btn-success">
            <i class="fas fa-plus me-2"></i>New Quote
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          {% if quotes %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Quote #</th>
                  <th>Route</th>
                  <th>Pickup Date</th>
                  <th>Car Types</th>
                  <th>Distance</th>
                  <th>Rate Type</th>
                  <th>Total Cost</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for quote in quotes %}
                <tr>
                  <td><strong>#{{ quote.id }}</strong></td>
                  <td>
                    <div class="small">
                      <strong>{{ quote.pickup_location }}, {{ quote.pickup_state }}</strong><br>
                      <i class="fas fa-arrow-down text-muted"></i><br>
                      <strong>{{ quote.delivery_location }}, {{ quote.delivery_state }}</strong>
                    </div>
                  </td>
                  <td>
                    <div>{{ quote.pickup_date.strftime('%m/%d/%Y') }}</div>
                    <small class="text-muted">{{ quote.pickup_time }}</small>
                  </td>
                  <td>
                    {% for car_type in quote.car_types|from_json %}
                      <span class="badge bg-info me-1">{{ car_type }}</span>
                    {% endfor %}
                    {% if quote.is_superload %}
                      <span class="badge bg-warning">Superload</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if quote.distance_miles %}
                      {{ "%.1f"|format(quote.distance_miles) }} mi
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>
                    {% if quote.rate_type %}
                      <span class="badge bg-{{ 'warning' if quote.rate_type == 'premium' else 'success' }}">
                        {{ quote.rate_type.title() }}
                      </span>
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>
                    {% if quote.total_cost %}
                      <strong>${{ "%.2f"|format(quote.total_cost) }}</strong>
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>{{ quote.created_at.strftime('%m/%d/%Y %H:%M') }}</td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <button type="button" class="btn btn-outline-primary" onclick="viewQuote({{ quote.id }})" title="View Details">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button type="button" class="btn btn-outline-secondary" onclick="duplicateQuote({{ quote.id }})" title="Duplicate">
                        <i class="fas fa-copy"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center py-5">
            <i class="fas fa-file-invoice-dollar text-muted" style="font-size: 4rem;"></i>
            <h4 class="mt-3 text-muted">No quotes yet</h4>
            <p class="text-muted">Create your first quote to get started</p>
            <a href="{{ url_for('get_quote') }}" class="btn btn-success">
              <i class="fas fa-plus me-2"></i>Create First Quote
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quote Details Modal -->
<div class="modal fade" id="quoteModal" tabindex="-1" aria-labelledby="quoteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="quoteModalLabel">Quote Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="quoteModalBody">
        <!-- Quote details will be loaded here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="printQuote()">
          <i class="fas fa-print me-2"></i>Print Quote
        </button>
      </div>
    </div>
  </div>
</div>

<script>
function viewQuote(quoteId) {
  const modalBody = document.getElementById('quoteModalBody');
  modalBody.innerHTML = `
    <div class="text-center py-4">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading quote details...</p>
    </div>
  `;
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('quoteModal'));
  modal.show();
  
  // Fetch quote details from server
  fetch(`/quote-details/${quoteId}`)
    .then(response => response.json())
    .then(quote => {
      modalBody.innerHTML = `
        <div class="row">
          <div class="col-12">
            <h6><i class="fas fa-info-circle me-2"></i>Quote Overview</h6>
            <div class="table-responsive mb-4">
              <table class="table table-sm table-bordered">
                <tbody>
                  <tr>
                    <td class="bg-light" style="width: 20%;"><strong>Quote ID</strong></td>
                    <td style="width: 30%;">#${quote.id}</td>
                    <td class="bg-light" style="width: 20%;"><strong>Company</strong></td>
                    <td style="width: 30%;">${quote.customer.company_name}</td>
                  </tr>
                  <tr>
                    <td class="bg-light"><strong>Email</strong></td>
                    <td><a href="mailto:${quote.customer.email}">${quote.customer.email}</a></td>
                    <td class="bg-light"><strong>Phone</strong></td>
                    <td>${quote.customer.phone_number ? '<a href="tel:' + quote.customer.phone_number + '">' + quote.customer.phone_number + '</a>' : 'Not provided'}</td>
                  </tr>
                  <tr>
                    <td class="bg-light"><strong>DOT Number</strong></td>
                    <td>${quote.customer.dot_number ? '<span class="badge bg-success">' + quote.customer.dot_number + '</span>' : 'Not provided'}</td>
                    <td class="bg-light"><strong>Created</strong></td>
                    <td>${quote.created_at}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <h6><i class="fas fa-route me-2"></i>Trip Details</h6>
            <div class="table-responsive mb-4">
              <table class="table table-sm table-bordered">
                <tbody>
                  <tr>
                    <td class="bg-light" style="width: 20%;"><strong>Pickup Date/Time</strong></td>
                    <td style="width: 30%;">${quote.pickup_date} at ${quote.pickup_time}</td>
                    <td class="bg-light" style="width: 20%;"><strong>Distance</strong></td>
                    <td style="width: 30%;">${quote.distance_miles.toFixed(1)} miles</td>
                  </tr>
                  <tr>
                    <td class="bg-light"><strong>From</strong></td>
                    <td>${quote.pickup_location}, ${quote.pickup_state}</td>
                    <td class="bg-light"><strong>To</strong></td>
                    <td>${quote.delivery_location}, ${quote.delivery_state}</td>
                  </tr>
                  <tr>
                    <td class="bg-light"><strong>Services</strong></td>
                    <td>${quote.car_types.map(type => '<span class="badge bg-primary me-1">' + type + '</span>').join('')}</td>
                    <td class="bg-light"><strong>Special Status</strong></td>
                    <td>${quote.is_superload ? '<span class="badge bg-danger">SUPERLOAD</span>' : '<span class="badge bg-success">Standard Load</span>'}</td>
                  </tr>
                  <tr>
                    <td class="bg-light"><strong>Region</strong></td>
                    <td>${quote.region}</td>
                    <td class="bg-light"><strong>Rate Type</strong></td>
                    <td><span class="badge bg-${quote.rate_type === 'premium' ? 'warning' : 'success'}">${quote.rate_type.charAt(0).toUpperCase() + quote.rate_type.slice(1)}</span></td>
                  </tr>
                  <tr>
                    <td class="bg-light"><strong>Total Cost</strong></td>
                    <td><h5 class="text-success mb-0">$${quote.total_cost.toFixed(2)}</h5></td>
                    <td class="bg-light"><strong>Priority</strong></td>
                    <td><span class="badge bg-${quote.total_cost > 1000 ? 'danger' : quote.total_cost > 500 ? 'warning' : 'info'}">${quote.total_cost > 1000 ? 'HIGH' : quote.total_cost > 500 ? 'MEDIUM' : 'STANDARD'}</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <hr>
        
        <div class="row">
          <div class="col-12 text-center">
            <div class="alert alert-success">
              <h6><i class="fas fa-truck me-2"></i>Ready to Order Pilot Car Services?</h6>
              <p class="mb-2">Convert this quote into an order with pre-filled information</p>
              <button type="button" class="btn btn-success" onclick="orderFromQuote(${quote.id})">
                <i class="fas fa-shopping-cart me-2"></i>Order Pilot Car Services
              </button>
            </div>
          </div>
        </div>
      `;
    })
    .catch(error => {
      console.error('Error fetching quote details:', error);
      modalBody.innerHTML = `
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Error loading quote details. Please try again.
        </div>
      `;
    });
}

function orderFromQuote(quoteId) {
  // Get quote data from the current view to build the order URL
  fetch(`/quote-details/${quoteId}`)
    .then(response => response.json())
    .then(quote => {
      const orderUrl = `/order-pilot-car?source=quote&pickup_address=${encodeURIComponent(quote.pickup_location + ', ' + quote.pickup_state)}&delivery_address=${encodeURIComponent(quote.delivery_location + ', ' + quote.delivery_state)}&pickup_date=${quote.pickup_date.replace(/\//g, '-')}&pickup_time=${quote.pickup_time}&pilot_car_positions=${encodeURIComponent(quote.car_types.join(' / '))}&quote_id=${quote.id}`;
      window.location.href = orderUrl;
    })
    .catch(error => {
      console.error('Error fetching quote for order:', error);
      alert('Error preparing order. Please try again.');
    });
}

function duplicateQuote(quoteId) {
  if (confirm('This will create a new quote based on Quote #' + quoteId + '. Continue?')) {
    // Fetch quote details and redirect to get-quote with pre-filled data
    fetch(`/quote-details/${quoteId}`)
      .then(response => response.json())
      .then(quote => {
        const quoteUrl = `/get-quote?duplicate=${quoteId}&pickup_location=${encodeURIComponent(quote.pickup_location)}&pickup_state=${quote.pickup_state}&delivery_location=${encodeURIComponent(quote.delivery_location)}&delivery_state=${quote.delivery_state}&pickup_date=${quote.pickup_date.replace(/\//g, '-')}&pickup_time=${quote.pickup_time}&car_types=${encodeURIComponent(JSON.stringify(quote.car_types))}&is_superload=${quote.is_superload}`;
        window.location.href = quoteUrl;
      })
      .catch(error => {
        console.error('Error fetching quote for duplication:', error);
        alert('Error duplicating quote. Please try again.');
      });
  }
}

function printQuote() {
  window.print();
}
</script>
{% endblock %}
