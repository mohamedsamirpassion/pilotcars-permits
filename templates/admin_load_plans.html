{% extends 'base.html' %}

{% block title %}Load Plan Management - Pilot Cars & Permits Admin{% endblock %}

{% block extra_head %}
<style>
  .state-badge {
    background: var(--pp-primary);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: bold;
  }
  
  .badge-yes {
    background: #28a745;
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.75em;
  }
  
  .badge-no {
    background: #6c757d;
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.75em;
  }
  
  .escort-badge {
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.75em;
    margin-right: 2px;
    color: white;
  }
  
  .escort-badge.escort-none { background: #28a745; }
  .escort-badge.escort-hp { background: #ffc107; color: #000; }
  .escort-badge.escort-front { background: #17a2b8; }
  .escort-badge.escort-rear { background: var(--pp-primary); }
  .escort-badge.escort-police { background: #dc3545; }
  .escort-badge.escort-other { background: #6c757d; }
  
  .results-container {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
  }
  
  .notes-cell {
    max-width: 200px;
    word-wrap: break-word;
    font-size: 0.85em;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2><i class="fas fa-route me-2"></i>Load Plan Management</h2>
          <p class="text-muted">Monitor customer load plans and escort requirements</p>
        </div>
        <div>
          <a href="/admin" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          {% if routes %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Plan ID</th>
                  <th>Customer</th>
                  <th>Route Details</th>
                  <th>Load Dimensions</th>
                  <th>States Involved</th>
                  <th>Escort Requirements</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for route, user in routes %}
                <tr>
                  <td><strong>#{{ route.id }}</strong></td>
                  <td>
                    <div>
                      <strong>{{ user.company_name }}</strong><br>
                      <small class="text-muted">{{ user.email }}</small><br>
                      {% if user.phone_number %}
                        <small><i class="fas fa-phone me-1"></i>{{ user.phone_number }}</small><br>
                      {% endif %}
                      {% if user.dot_number %}
                        <small><i class="fas fa-truck me-1"></i>DOT: {{ user.dot_number }}</small>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    <div class="small">
                      <strong>{{ route.route_name }}</strong><br>
                      <strong>From:</strong> {{ route.origin[:30] }}{% if route.origin|length > 30 %}...{% endif %}<br>
                      <strong>To:</strong> {{ route.destination[:30] }}{% if route.destination|length > 30 %}...{% endif %}<br>
                      <span class="badge bg-secondary">{{ route.road_type }}</span>
                    </div>
                  </td>
                  <td>
                    <div class="small">
                      <i class="fas fa-arrows-alt-h text-primary"></i> <strong>W:</strong> {{ route.width }}ft<br>
                      <i class="fas fa-arrows-alt-v text-info"></i> <strong>H:</strong> {{ route.height }}ft<br>
                      <i class="fas fa-ruler text-success"></i> <strong>L:</strong> {{ route.length }}ft<br>
                      <i class="fas fa-weight-hanging text-warning"></i> <strong>{{ "{:,}".format(route.weight|int) }}</strong> lbs
                      {% if route.front_overhang > 0 or route.rear_overhang > 0 %}
                        <br><small class="text-muted">
                          {% if route.front_overhang > 0 %}Front: {{ route.front_overhang }}ft{% endif %}
                          {% if route.rear_overhang > 0 %}{% if route.front_overhang > 0 %}, {% endif %}Rear: {{ route.rear_overhang }}ft{% endif %}
                        </small>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    {% set states = route.custom_route|from_json %}
                    {% if states %}
                      {% for state in states[:3] %}
                        <span class="badge bg-primary me-1">{{ state }}</span>
                      {% endfor %}
                      {% if states|length > 3 %}
                        <br><span class="badge bg-light text-dark">+{{ states|length - 3 }} more</span>
                      {% endif %}
                    {% else %}
                      <span class="text-muted">No route defined</span>
                    {% endif %}
                  </td>
                  <td>
                    {% set results = route.route_results|from_json %}
                    {% if results %}
                      {% set escort_count = 0 %}
                      {% set total_states = results|length %}
                      {% for result in results %}
                        {% if result.escort_requirements != 'None Required' and result.escort_requirements != 'No data available' %}
                          {% set escort_count = escort_count + 1 %}
                        {% endif %}
                      {% endfor %}
                      
                      {% if escort_count > 0 %}
                        <span class="badge bg-warning text-dark">{{ escort_count }}/{{ total_states }} States</span><br>
                        <small class="text-danger">Escorts Required</small>
                      {% else %}
                        <span class="badge bg-success">{{ total_states }} States</span><br>
                        <small class="text-success">No Escorts Needed</small>
                      {% endif %}
                    {% else %}
                      <span class="badge bg-secondary">Unknown</span>
                    {% endif %}
                  </td>
                  <td>{{ route.created_at.strftime('%m/%d/%Y %H:%M') }}</td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <button type="button" class="btn btn-outline-primary" 
                              onclick="viewLoadPlan({{ route.id }})" title="View Details">
                        <i class="fas fa-search"></i>
                      </button>
                      <a href="mailto:{{ user.email }}?subject=Escort Services for {{ route.route_name }}&body=Hello {{ user.company_name }},%0D%0A%0D%0AI reviewed your load plan '{{ route.route_name }}' and noticed it may require pilot car escort services.%0D%0A%0D%0ALoad Details:%0D%0A- Route: {{ route.origin }} to {{ route.destination }}%0D%0A- Dimensions: {{ route.width }}' W x {{ route.height }}' H x {{ route.length }}' L%0D%0A- Weight: {{ "{:,}".format(route.weight|int) }} lbs%0D%0A%0D%0APilot Cars & Permits can provide professional escort services. Please let me know if you'd like a quote.%0D%0A%0D%0ABest regards,%0D%0APilot Cars & Permits Team" 
                         class="btn btn-outline-success" title="Contact Customer">
                        <i class="fas fa-envelope"></i>
                      </a>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center py-5">
            <i class="fas fa-route text-muted" style="font-size: 4rem;"></i>
            <h4 class="mt-3 text-muted">No load plans yet</h4>
            <p class="text-muted">Customer load plans will appear here when they create route analyses</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Load Plan Details Modal -->
<div class="modal fade" id="loadPlanModal" tabindex="-1" aria-labelledby="loadPlanModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loadPlanModalLabel">Load Plan Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="loadPlanModalBody">
        <!-- Load plan details will be loaded here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="generateQuoteFromPlan()">
          <i class="fas fa-dollar-sign me-2"></i>Generate Quote
        </button>
      </div>
    </div>
  </div>
</div>

<script>
function viewLoadPlan(routeId) {
  // Route data for detailed view
  const routes = [
    {% for route, user in routes %}
    {
      id: {{ route.id }},
      customer: {
        company_name: "{{ user.company_name }}",
        email: "{{ user.email }}",
        phone_number: "{{ user.phone_number or '' }}",
        dot_number: "{{ user.dot_number or '' }}"
      },
      route_name: "{{ route.route_name }}",
      origin: "{{ route.origin }}",
      destination: "{{ route.destination }}",
      road_type: "{{ route.road_type }}",
      width: {{ route.width }},
      height: {{ route.height }},
      length: {{ route.length }},
      weight: {{ route.weight }},
      front_overhang: {{ route.front_overhang or 0 }},
      rear_overhang: {{ route.rear_overhang or 0 }},
      custom_route: {{ route.custom_route|safe if route.custom_route else '[]' }},
      results: {{ route.route_results|safe if route.route_results else '[]' }},
      created_at: "{{ route.created_at.strftime('%m/%d/%Y %I:%M %p') }}"
    },
    {% endfor %}
  ];
  
  const route = routes.find(r => r.id === routeId);
  if (!route) {
    alert('Load plan not found');
    return;
  }
  
  const modalBody = document.getElementById('loadPlanModalBody');
  modalBody.innerHTML = `
    <div class="row">
      <div class="col-md-6">
        <h6>Customer Information</h6>
        <table class="table table-sm">
          <tr>
            <td><strong>Company:</strong></td>
            <td>${route.customer.company_name}</td>
          </tr>
          <tr>
            <td><strong>Contact:</strong></td>
            <td>
              <a href="mailto:${route.customer.email}">${route.customer.email}</a>
              ${route.customer.phone_number ? '<br><a href="tel:' + route.customer.phone_number + '">' + route.customer.phone_number + '</a>' : ''}
            </td>
          </tr>
          ${route.customer.dot_number ? `
          <tr>
            <td><strong>DOT Number:</strong></td>
            <td><span class="badge bg-success">${route.customer.dot_number}</span></td>
          </tr>
          ` : ''}
        </table>
        
        <h6>Route Information</h6>
        <table class="table table-sm">
          <tr>
            <td><strong>Plan ID:</strong></td>
            <td>#${route.id}</td>
          </tr>
          <tr>
            <td><strong>Route Name:</strong></td>
            <td>${route.route_name}</td>
          </tr>
          <tr>
            <td><strong>Origin:</strong></td>
            <td>${route.origin}</td>
          </tr>
          <tr>
            <td><strong>Destination:</strong></td>
            <td>${route.destination}</td>
          </tr>
          <tr>
            <td><strong>Road Type:</strong></td>
            <td><span class="badge bg-secondary">${route.road_type}</span></td>
          </tr>
          <tr>
            <td><strong>Created:</strong></td>
            <td>${route.created_at}</td>
          </tr>
        </table>
      </div>
      
      <div class="col-md-6">
        <h6>Load Specifications</h6>
        <div class="card bg-light">
          <div class="card-body">
            <div class="row">
              <div class="col-6">
                <p class="mb-1"><i class="fas fa-arrows-alt-h text-primary"></i> <strong>Width:</strong> ${route.width} ft</p>
                <p class="mb-1"><i class="fas fa-arrows-alt-v text-info"></i> <strong>Height:</strong> ${route.height} ft</p>
              </div>
              <div class="col-6">
                <p class="mb-1"><i class="fas fa-ruler text-success"></i> <strong>Length:</strong> ${route.length} ft</p>
                <p class="mb-1"><i class="fas fa-weight-hanging text-warning"></i> <strong>Weight:</strong> ${route.weight.toLocaleString()} lbs</p>
              </div>
            </div>
            ${route.front_overhang > 0 || route.rear_overhang > 0 ? `
            <hr class="my-2">
            <div class="row">
              <div class="col-12">
                <small class="text-muted">
                  <strong>Overhangs:</strong>
                  ${route.front_overhang > 0 ? 'Front: ' + route.front_overhang + ' ft' : ''}
                  ${route.front_overhang > 0 && route.rear_overhang > 0 ? ', ' : ''}
                  ${route.rear_overhang > 0 ? 'Rear: ' + route.rear_overhang + ' ft' : ''}
                </small>
              </div>
            </div>
            ` : ''}
          </div>
        </div>
        
        <h6 class="mt-3">Route Path</h6>
        <div>
          ${route.custom_route && route.custom_route.length > 0 ? 
            route.custom_route.map(state => '<span class="badge bg-primary me-1">' + state + '</span>').join(' → ') :
            '<span class="text-muted">No custom route defined</span>'
          }
        </div>
      </div>
    </div>
    
    <hr>
    
    <div class="row">
      <div class="col-12">
        <h6>Escort Requirements Analysis</h6>
  `;
  
  // Add escort requirements analysis with the same format as customer view
  if (route.results && route.results.length > 0) {
    let tableContent = `
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-dark">
              <tr>
                <th>State</th>
                <th>Road Type</th>
                <th>Route Survey</th>
                <th>Police Escort</th>
                <th>Escort Requirements</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    // Add each state as a separate row
    route.results.forEach(result => {
      const requirements = result.escort_requirements || 'None Required';
      const escortInfo = processEscortRequirements(requirements);
      
      tableContent += `
              <tr>
                <td><span class="state-badge">${result.state}</span></td>
                <td>${result.road_type}</td>
                <td>${escortInfo.routeSurvey ? '<span class="badge-yes">Yes</span>' : '<span class="badge-no">No</span>'}</td>
                <td>${escortInfo.policeEscort ? '<span class="badge-yes">Yes</span>' : '<span class="badge-no">No</span>'}</td>
                <td>${getEscortBadge(escortInfo.finalRequirements)}</td>
                <td class="notes-cell">${result.notes || 'No additional notes'}</td>
              </tr>
      `;
    });
    
    tableContent += `
            </tbody>
          </table>
        </div>
    `;
    
    modalBody.innerHTML += tableContent;
  } else {
    modalBody.innerHTML += `
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          No escort requirements analysis available for this load plan.
        </div>
    `;
  }
  
  modalBody.innerHTML += `
      </div>
    </div>
    
    <hr>
    
    <div class="row">
      <div class="col-md-6">
        <h6>Summary</h6>
  `;
  
  // Add summary and actions
  const escortStates = route.results ? route.results.filter(r => 
    r.escort_requirements && r.escort_requirements !== 'None Required' && r.escort_requirements !== 'No data available'
  ).length : 0;
  
  modalBody.innerHTML += `
        <div class="card ${escortStates > 0 ? 'bg-warning' : 'bg-success'} text-dark">
          <div class="card-body">
            <h5 class="card-title">
              <i class="fas ${escortStates > 0 ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i>
              ${escortStates > 0 ? 'Escort Services Required' : 'No Escorts Required'}
            </h5>
            <p class="card-text">
              ${escortStates > 0 ? 
                escortStates + ' state(s) require pilot car escort services' :
                'This load can travel without escort services in all analyzed states'
              }
            </p>
            ${escortStates > 0 ? 
              '<small><strong>Business Opportunity:</strong> Contact customer to offer escort services</small>' :
              '<small><strong>Status:</strong> Customer compliant for planned route</small>'
            }
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <h6>Admin Actions</h6>
        <div class="d-grid gap-2">
          <a href="mailto:${route.customer.email}?subject=Escort Services for ${route.route_name}&body=Hello ${route.customer.company_name},%0D%0A%0D%0AI reviewed your load plan '${route.route_name}' and ${escortStates > 0 ? 'noticed it requires pilot car escort services in ' + escortStates + ' state(s)' : 'confirmed it meets regulations without escorts'}." 
             class="btn btn-outline-primary btn-sm">
            <i class="fas fa-envelope me-2"></i>Contact Customer
          </a>
          ${route.customer.phone_number ? `
          <a href="tel:${route.customer.phone_number}" class="btn btn-outline-success btn-sm">
            <i class="fas fa-phone me-2"></i>Call Customer
          </a>
          ` : ''}
          ${escortStates > 0 ? `
          <button class="btn btn-outline-warning btn-sm" onclick="generateQuoteFromPlan(${route.id})">
            <i class="fas fa-dollar-sign me-2"></i>Generate Quote
          </button>
          ` : ''}
          <button class="btn btn-outline-info btn-sm" onclick="exportLoadPlan(${route.id})">
            <i class="fas fa-download me-2"></i>Export Plan
          </button>
        </div>
      </div>
    </div>
  `;
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('loadPlanModal'));
  modal.show();
}

function generateQuoteFromPlan(routeId) {
  alert('Quote generation from load plan functionality will be implemented. This would pre-fill a quote form based on the load plan requirements.');
}

function exportLoadPlan(routeId) {
  alert('Load plan export functionality will be implemented');
}

// Process escort requirements with High Pole logic (same as customer view)
function processEscortRequirements(requirements) {
  if (!requirements || requirements === 'None Required') {
    return {
      routeSurvey: false,
      policeEscort: false,
      finalRequirements: 'None Required'
    };
  }
  
  const reqString = requirements.toLowerCase();
  const routeSurvey = reqString.includes('route survey');
  const policeEscort = reqString.includes('police');
  
  // Parse individual escort requirements
  let hasRear = reqString.includes('rear');
  let hasFront = reqString.includes('front');
  let hasHP = reqString.includes('high pole') || reqString.includes('hp');
  
  // Apply High Pole logic: HP replaces Front
  if (hasHP && hasFront) {
    hasFront = false; // HP replaces front
  }
  
  // Build final requirements
  const finalReqs = [];
  if (hasHP) finalReqs.push('High Pole');
  if (hasFront) finalReqs.push('Front');
  if (hasRear) finalReqs.push('Rear');
  
  return {
    routeSurvey,
    policeEscort,
    finalRequirements: finalReqs.length > 0 ? finalReqs.join(', ') : 'None Required'
  };
}

function getEscortBadge(requirements) {
  if (requirements === 'None Required') {
    return '<span class="escort-badge escort-none">None Required</span>';
  }
  
  const badges = requirements.split(', ').map(req => {
    const reqLower = req.toLowerCase();
    let className = 'escort-badge';
    
    if (reqLower.includes('high pole')) {
      className += ' escort-hp';
    } else if (reqLower.includes('front')) {
      className += ' escort-front';
    } else if (reqLower.includes('rear')) {
      className += ' escort-rear';
    } else if (reqLower.includes('police')) {
      className += ' escort-police';
    } else {
      className += ' escort-other';
    }
    
    return `<span class="${className}">${req}</span>`;
  });
  
  return badges.join(' ');
}
</script>
{% endblock %} 