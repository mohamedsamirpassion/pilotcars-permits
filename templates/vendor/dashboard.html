{% extends "base.html" %}

{% block title %}Vendor Dashboard - My PEVO{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-tachometer-alt me-2"></i>Vendor Dashboard</h2>
                    <p class="text-muted">Manage your location and availability for pilot car escort services.</p>
                </div>
                <div>
                    <a href="/vendor/share-location" class="btn btn-success">
                        <i class="fas fa-plus me-2"></i>Update My Location
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Vendor Access Information -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Vendor Access Information</strong><br>
                As a registered vendor, you can share your location and availability for pilot car escort services. Your location will be visible to administrators and coordinators who can match you with nearby jobs. Vendor accounts do not have access to quote generation or load planning features.
            </div>
        </div>
    </div>

    <div class="row">
        <!-- My Information -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-user me-2"></i>My Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-4"><strong>Company Name:</strong></div>
                        <div class="col-sm-8">{{ user.company_name }}</div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-sm-4"><strong>Contact Name:</strong></div>
                        <div class="col-sm-8">{{ user.contact_name or 'Not specified' }}</div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-sm-4"><strong>Contact Phone:</strong></div>
                        <div class="col-sm-8">{{ user.phone_number or 'Not specified' }}</div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-sm-4"><strong>Contact Email:</strong></div>
                        <div class="col-sm-8">{{ user.email }}</div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-sm-4"><strong>Services Provided:</strong></div>
                        <div class="col-sm-8">
                            {% if active_locations %}
                                {% for location in active_locations[:1] %}
                                    {% set services = location.services_provided | from_json %}
                                    {% for service in services %}
                                        <span class="badge bg-secondary me-1">{{ service }}</span>
                                    {% endfor %}
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">No active location shared</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mt-3">
                        <a href="#" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-edit me-2"></i>Update Services
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Location -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Current Location</h5>
                </div>
                <div class="card-body">
                    {% if active_locations %}
                        {% for location in active_locations[:1] %}
                            <div class="mb-3">
                                <h6 class="text-success">{{ location.location_city }}, {{ location.location_state }}</h6>
                                <div class="row">
                                    <div class="col-sm-5"><strong>Coverage Radius:</strong></div>
                                    <div class="col-sm-7">{{ location.coverage_radius }} miles</div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-5"><strong>Shared On:</strong></div>
                                    <div class="col-sm-7">{{ location.created_at.strftime('%m-%d-%Y %I:%M %p') }}</div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-5"><strong>Expires On:</strong></div>
                                    <div class="col-sm-7">{{ location.expires_at.strftime('%m-%d-%Y %I:%M %p') }}</div>
                                </div>
                                {% if location.notes %}
                                <div class="row mt-2">
                                    <div class="col-sm-5"><strong>Notes:</strong></div>
                                    <div class="col-sm-7">{{ location.notes }}</div>
                                </div>
                                {% endif %}
                            </div>

                            <div id="map" style="height: 300px; width: 100%; border-radius: 5px;"></div>

                            <div class="mt-3 text-center">
                                <i class="fas fa-clock text-warning me-2"></i>
                                <small class="text-muted">Your current location is active for 48 hours. To update your location, click the "Update My Location" button.</small>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">No Active Location</h6>
                            <p class="text-muted">You haven't shared your location yet. Share your location to be visible to coordinators for job opportunities.</p>
                            <a href="/vendor/share-location" class="btn btn-success">
                                <i class="fas fa-map-marker-alt me-2"></i>Share My Location
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Location History -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Location History</h5>
                </div>
                <div class="card-body">
                    {% if active_locations %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Location</th>
                                        <th>Coverage</th>
                                        <th>Services</th>
                                        <th>Shared</th>
                                        <th>Expires</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for location in active_locations %}
                                        <tr>
                                            <td>
                                                <strong>{{ location.location_city }}, {{ location.location_state }}</strong>
                                            </td>
                                            <td>{{ location.coverage_radius }} miles</td>
                                            <td>
                                                {% set services = location.services_provided | from_json %}
                                                {% for service in services %}
                                                    <span class="badge bg-secondary me-1">{{ service }}</span>
                                                {% endfor %}
                                            </td>
                                            <td>{{ location.created_at.strftime('%m/%d/%Y %I:%M %p') }}</td>
                                            <td>{{ location.expires_at.strftime('%m/%d/%Y %I:%M %p') }}</td>
                                            <td>
                                                {% if location.expires_at > moment().utcnow() %}
                                                    <span class="badge bg-success">Active</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Expired</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-clock fa-2x text-muted mb-3"></i>
                            <h6 class="text-muted">No Location History</h6>
                            <p class="text-muted">Your shared locations will appear here once you start sharing your availability.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% if active_locations %}
<script>
let map;

function initMap() {
    {% for location in active_locations[:1] %}
    const location = {
        lat: {{ location.latitude }},
        lng: {{ location.longitude }}
    };

    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 10,
        center: location,
        mapTypeId: 'roadmap'
    });

    // Add marker for current location
    const marker = new google.maps.Marker({
        position: location,
        map: map,
        title: '{{ location.location_city }}, {{ location.location_state }}',
        icon: {
            url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
        }
    });

    // Add coverage radius circle
    const coverageCircle = new google.maps.Circle({
        strokeColor: '#28a745',
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: '#28a745',
        fillOpacity: 0.15,
        map: map,
        center: location,
        radius: {{ location.coverage_radius }} * 1609.34 // Convert miles to meters
    });
    {% endfor %}
}
</script>

<!-- Google Maps API -->
<script async defer 
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB7POzdvk3ri7buWrkOLV7nNZK8pSeOxao&callback=initMap">
</script>
{% endif %}
{% endblock %} 