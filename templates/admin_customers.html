{% extends 'base.html' %}

{% block title %}Customer Management - My PEVO Admin{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2><i class="fas fa-users me-2"></i>Customer Management</h2>
          <p class="text-muted">View and manage customer accounts and contact information</p>
        </div>
        <div>
          <a href="/admin" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          {% if users %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Company Details</th>
                  <th>Contact Information</th>
                  <th>DOT Number</th>
                  <th>Account Status</th>
                  <th>Activity</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for user in users %}
                <tr>
                  <td><strong>#{{ user.id }}</strong></td>
                  <td>
                    <div>
                      <strong>{{ user.company_name }}</strong><br>
                      <small class="text-muted">{{ user.email }}</small>
                    </div>
                  </td>
                  <td>
                    <div>
                      {% if user.phone_number %}
                        <i class="fas fa-phone text-primary me-1"></i>{{ user.phone_number }}<br>
                      {% else %}
                        <span class="text-muted">No phone number</span><br>
                      {% endif %}
                      <i class="fas fa-envelope text-info me-1"></i>
                      <a href="mailto:{{ user.email }}">{{ user.email }}</a>
                    </div>
                  </td>
                  <td>
                    {% if user.dot_number %}
                      <span class="badge bg-success">{{ user.dot_number }}</span>
                    {% else %}
                      <span class="badge bg-warning">No DOT#</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-success">Active</span><br>
                    <small class="text-muted">Joined {{ user.created_at.strftime('%m/%d/%Y') }}</small>
                  </td>
                  <td>
                    <div class="small">
                      <strong>{{ user.routes|length }}</strong> Load Plans<br>
                      <strong>{{ user.quotes|length }}</strong> Quotes<br>
                      {% if user.quotes %}
                        Last: {{ user.quotes[-1].created_at.strftime('%m/%d/%Y') }}
                      {% else %}
                        <span class="text-muted">No activity</span>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <button type="button" class="btn btn-outline-primary" 
                              onclick="viewCustomer({{ user.id }})" title="View Details">
                        <i class="fas fa-eye"></i>
                      </button>
                      <a href="mailto:{{ user.email }}?subject=My PEVO Services&body=Hello {{ user.company_name }},%0D%0A%0D%0AThank you for using My PEVO services. We're here to help with your pilot car escort needs.%0D%0A%0D%0ABest regards,%0D%0AMy PEVO Team" 
                         class="btn btn-outline-success" title="Send Email">
                        <i class="fas fa-envelope"></i>
                      </a>
                      {% if user.phone_number %}
                      <a href="tel:{{ user.phone_number }}" class="btn btn-outline-info" title="Call Customer">
                        <i class="fas fa-phone"></i>
                      </a>
                      {% endif %}
                      {% if session.is_super_admin %}
                      <button type="button" class="btn btn-outline-warning" 
                              onclick="resetCustomerPassword({{ user.id }}, '{{ user.company_name }}', '{{ user.user_type }}')" 
                              title="Reset Password">
                        <i class="fas fa-key"></i>
                      </button>
                      {% endif %}
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center py-5">
            <i class="fas fa-users text-muted" style="font-size: 4rem;"></i>
            <h4 class="mt-3 text-muted">No customers yet</h4>
            <p class="text-muted">Customer accounts will appear here when they register</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Customer Details Modal -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customerModalLabel">Customer Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="customerModalBody">
        <!-- Customer details will be loaded here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="exportCustomer()">
          <i class="fas fa-download me-2"></i>Export Data
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Password Reset Modal -->
<div class="modal fade" id="passwordResetModal" tabindex="-1" aria-labelledby="passwordResetModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="passwordResetModalLabel">
          <i class="fas fa-key me-2"></i>Reset Customer Password
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Warning:</strong> This will reset the customer's password. They will need to use the new temporary password to log in.
        </div>
        
        <div class="mb-3">
          <strong>Customer:</strong> <span id="resetCustomerName"></span><br>
          <strong>Type:</strong> <span id="resetCustomerType"></span>
        </div>
        
        <form id="passwordResetForm">
          <div class="mb-3">
            <label for="newPassword" class="form-label">
              <i class="fas fa-lock me-1"></i>New Temporary Password
            </label>
            <input type="password" class="form-control" id="newPassword" required minlength="6"
                   placeholder="Enter temporary password (min 6 characters)">
            <div class="form-text">Customer will need to change this password after logging in.</div>
          </div>
          
          <div class="mb-3">
            <label for="confirmPassword" class="form-label">
              <i class="fas fa-lock me-1"></i>Confirm Password
            </label>
            <input type="password" class="form-control" id="confirmPassword" required minlength="6"
                   placeholder="Confirm temporary password">
          </div>
          
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="confirmReset" required>
            <label class="form-check-label" for="confirmReset">
              I understand this will reset the customer's password and they will need to use the new temporary password.
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" onclick="confirmPasswordReset()">
          <i class="fas fa-key me-2"></i>Reset Password
        </button>
      </div>
    </div>
  </div>
</div>

<script>
function viewCustomer(customerId) {
  // Customer data for the modal
  const customers = [
    {% for user in users %}
    {
      id: {{ user.id }},
      company_name: "{{ user.company_name }}",
      email: "{{ user.email }}",
      phone_number: "{{ user.phone_number or '' }}",
      dot_number: "{{ user.dot_number or '' }}",
      created_at: "{{ user.created_at.strftime('%m/%d/%Y %I:%M %p') }}",
      routes_count: {{ user.routes|length }},
      quotes_count: {{ user.quotes|length }}
    },
    {% endfor %}
  ];
  
  const customer = customers.find(c => c.id === customerId);
  if (!customer) {
    alert('Customer not found');
    return;
  }
  
  const modalBody = document.getElementById('customerModalBody');
  modalBody.innerHTML = `
    <div class="row">
      <div class="col-md-6">
        <h6>Company Information</h6>
        <table class="table table-sm">
          <tr>
            <td><strong>Customer ID:</strong></td>
            <td>#${customer.id}</td>
          </tr>
          <tr>
            <td><strong>Company Name:</strong></td>
            <td>${customer.company_name}</td>
          </tr>
          <tr>
            <td><strong>DOT Number:</strong></td>
            <td>${customer.dot_number || '<span class="text-muted">Not provided</span>'}</td>
          </tr>
          <tr>
            <td><strong>Registration Date:</strong></td>
            <td>${customer.created_at}</td>
          </tr>
        </table>
      </div>
      
      <div class="col-md-6">
        <h6>Contact Information</h6>
        <table class="table table-sm">
          <tr>
            <td><strong>Email:</strong></td>
            <td><a href="mailto:${customer.email}">${customer.email}</a></td>
          </tr>
          <tr>
            <td><strong>Phone:</strong></td>
            <td>${customer.phone_number ? '<a href="tel:' + customer.phone_number + '">' + customer.phone_number + '</a>' : '<span class="text-muted">Not provided</span>'}</td>
          </tr>
          <tr>
            <td><strong>Status:</strong></td>
            <td><span class="badge bg-success">Active</span></td>
          </tr>
        </table>
      </div>
    </div>
    
    <hr>
    
    <div class="row">
      <div class="col-md-6">
        <h6>Activity Summary</h6>
        <div class="card bg-light">
          <div class="card-body text-center">
            <div class="row">
              <div class="col-6">
                <h4 class="text-primary">${customer.routes_count}</h4>
                <p class="mb-0">Load Plans</p>
              </div>
              <div class="col-6">
                <h4 class="text-success">${customer.quotes_count}</h4>
                <p class="mb-0">Quotes</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <h6>Quick Actions</h6>
        <div class="d-grid gap-2">
          <a href="mailto:${customer.email}?subject=My PEVO Services&body=Hello ${customer.company_name},%0D%0A%0D%0AThank you for using My PEVO services." 
             class="btn btn-outline-primary btn-sm">
            <i class="fas fa-envelope me-2"></i>Send Email
          </a>
          ${customer.phone_number ? `
          <a href="tel:${customer.phone_number}" class="btn btn-outline-success btn-sm">
            <i class="fas fa-phone me-2"></i>Call Customer
          </a>
          ` : ''}
          <button class="btn btn-outline-info btn-sm" onclick="viewCustomerActivity(${customer.id})">
            <i class="fas fa-chart-line me-2"></i>View Activity
          </button>
        </div>
      </div>
    </div>
  `;
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('customerModal'));
  modal.show();
}

function viewCustomerActivity(customerId) {
  // This would show detailed activity for the customer
  alert(`Viewing activity for customer #${customerId}. This feature will show detailed load plans and quotes.`);
}

function exportCustomer() {
  alert('Customer data export functionality will be implemented');
}

// Password Reset Functions
let currentResetCustomerId = null;

function resetCustomerPassword(customerId, customerName, userType) {
  currentResetCustomerId = customerId;
  
  // Set customer info in modal
  document.getElementById('resetCustomerName').textContent = customerName;
  document.getElementById('resetCustomerType').textContent = userType === 'trucking_company' ? 'Trucking Company' : 'Pilot';
  
  // Clear form
  document.getElementById('passwordResetForm').reset();
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('passwordResetModal'));
  modal.show();
}

function confirmPasswordReset() {
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  const confirmCheckbox = document.getElementById('confirmReset').checked;
  
  // Validation
  if (!newPassword || newPassword.length < 6) {
    alert('Password must be at least 6 characters long');
    return;
  }
  
  if (newPassword !== confirmPassword) {
    alert('Passwords do not match');
    return;
  }
  
  if (!confirmCheckbox) {
    alert('Please confirm that you understand the implications of resetting the password');
    return;
  }
  
  // Show loading state
  const resetButton = document.querySelector('#passwordResetModal .btn-warning');
  const originalText = resetButton.innerHTML;
  resetButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Resetting...';
  resetButton.disabled = true;
  
  // Send reset request
  fetch(`/admin/reset-customer-password/${currentResetCustomerId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      new_password: newPassword
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Show success message
      alert(data.message + '\n\nPlease provide the customer with their new temporary password securely.');
      
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('passwordResetModal'));
      modal.hide();
      
      // Reset form
      document.getElementById('passwordResetForm').reset();
      currentResetCustomerId = null;
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('An error occurred while resetting the password. Please try again.');
  })
  .finally(() => {
    // Restore button state
    resetButton.innerHTML = originalText;
    resetButton.disabled = false;
  });
}

// Clear form when modal is hidden
document.getElementById('passwordResetModal').addEventListener('hidden.bs.modal', function () {
  document.getElementById('passwordResetForm').reset();
  currentResetCustomerId = null;
});
</script>
{% endblock %} 