{% extends "base.html" %}

{% block title %}Load Plan - My PEVO{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <div class="row mb-3">
        <div class="col-12">
            <h2><i class="fas fa-route me-2"></i>Load Plan Service</h2>
            <p class="text-muted">Plan your oversized load route and check escort requirements</p>
        </div>
    </div>

    <div class="row load-plan-container">
        <!-- Map Section (40% width) -->
        <div class="col-lg-5">
            <div class="map-container">
                <div id="map"></div>
                <div class="map-controls">
                    <button class="btn btn-sm btn-outline-primary" onclick="resetMap()">
                        <i class="fas fa-refresh"></i> Reset
                    </button>
                </div>
            </div>
        </div>

        <!-- Form Section (60% width) -->
        <div class="col-lg-7">
            <div class="info-panel">
                <!-- Trip Information -->
                <div class="form-section">
                    <h5><i class="fas fa-map-marker-alt me-2"></i>Trip Information</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="origin" class="form-label">Origin (City, State, ZIP)</label>
                                <input type="text" class="form-control" id="origin" placeholder="Charlotte, NC" autocomplete="off">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="destination" class="form-label">Destination (City, State, ZIP)</label>
                                <input type="text" class="form-control" id="destination" placeholder="Mobile, AL" autocomplete="off">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Road Type -->
                <div class="form-section">
                    <h5><i class="fas fa-road me-2"></i>Road Type</h5>
                    <div class="row">
                        <div class="col-12">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="road_type" id="interstate" value="Interstate" checked>
                                <label class="form-check-label" for="interstate">
                                    Interstate (4 lanes)
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="road_type" id="non_interstate" value="Non-Interstate">
                                <label class="form-check-label" for="non_interstate">
                                    Non-Interstate (2 lanes)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Overall Dimensions -->
                <div class="form-section">
                    <h5><i class="fas fa-ruler me-2"></i>Overall Dimensions (Including Trailer & Tractor)</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="length" class="form-label">Length (ft)</label>
                                <input type="number" class="form-control dimension-input" id="length" step="0.1" placeholder="75.0">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="width" class="form-label">Width (ft)</label>
                                <input type="number" class="form-control dimension-input" id="width" step="0.1" placeholder="8.5">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="height" class="form-label">Height (ft)</label>
                                <input type="number" class="form-control dimension-input" id="height" step="0.1" placeholder="13.6">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="weight" class="form-label">Weight (lbs)</label>
                                <input type="number" class="form-control dimension-input" id="weight" step="1" placeholder="80000">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Overhang (Optional) -->
                <div class="form-section">
                    <h5><i class="fas fa-arrows-alt-h me-2"></i>Overhang (Optional)</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="front_overhang" class="form-label">Front Overhang (ft)</label>
                                <input type="number" class="form-control dimension-input" id="front_overhang" step="0.1" placeholder="0.0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="rear_overhang" class="form-label">Rear Overhang (ft)</label>
                                <input type="number" class="form-control dimension-input" id="rear_overhang" step="0.1" placeholder="0.0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Custom Route -->
                <div class="form-section">
                    <h5><i class="fas fa-route me-2"></i>Custom Route <span class="text-danger">*Required</span></h5>
                    <p class="text-muted small">Select the states your load will travel through in order</p>
                    
                    <div class="route-builder">
                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="autoDetectStates()">
                                <i class="fas fa-magic me-1"></i>Auto-Detect Route States
                            </button>
                            <small class="text-muted ms-2">Or manually select states below</small>
                        </div>
                        
                        <!-- State Search Input -->
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-md-6 position-relative">
                                    <input type="text" class="form-control" id="state-search" placeholder="Type state name or abbreviation..." autocomplete="off">
                                    <div id="state-suggestions" class="state-suggestions" style="display: none;"></div>
                                </div>
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-outline-secondary" onclick="clearRoute()">
                                        <i class="fas fa-times me-1"></i>Clear All States
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="selected-route" id="selected-route" style="display: none;">
                            <strong>Selected Route:</strong> <span id="route-display"></span>
                        </div>
                    </div>
                </div>

                <!-- Calculate Button -->
                <div class="form-section">
                    <button type="button" class="btn btn-primary btn-lg w-100" onclick="calculateRoute()">
                        <i class="fas fa-calculator me-2"></i>Calculate Escort Requirements
                    </button>
                </div>

                <!-- Loading Spinner -->
                <div id="loading" class="loading" style="display: none;">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Calculating escort requirements...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Full Width Results Section -->
<div class="container-fluid py-4" id="results-section" style="display: none;">
    <div class="row">
        <div class="col-12">
                    <!-- Route Summary -->
                    <div id="route-summary" class="route-summary">
                        <h4><i class="fas fa-info-circle me-2"></i>Route Summary</h4>
                        <div id="summary-content"></div>
                    </div>

            <!-- Results Table -->
            <div class="results-container">
                <div class="table-responsive">
                    <table class="table" id="results-table">
                        <thead>
                            <tr>
                                <th>State</th>
                                <th>Road Type</th>
                                <th>Route Survey</th>
                                <th>Police Escort</th>
                                <th>Escort Requirements</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Save Route -->
            <div class="form-section">
                <div class="row">
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="route-name" placeholder="Enter route name to save">
                    </div>
                    <div class="col-md-4">
                        <button type="button" class="btn btn-success w-100" onclick="saveRoute()">
                            <i class="fas fa-save me-2"></i>Save Route
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Google Maps API -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB7POzdvk3ri7buWrkOLV7nNZK8pSeOxao&libraries=places&callback=initMap"></script>

<script>
// Global variables
let map;
let directionsService;
let directionsRenderer;
let selectedStates = [];
let currentResults = null;
let originAutocomplete;
let destinationAutocomplete;

// Initialize Google Map
function initMap() {
    try {
        console.log('Initializing Google Maps...');
        
        // Initialize map centered on the US
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 6,
            center: { lat: 38.9072, lng: -77.0369 }, // Washington DC
            mapTypeId: google.maps.MapTypeId.ROADMAP
        });
        
        // Initialize directions service and renderer
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            draggable: true,
            panel: null
        });
        directionsRenderer.setMap(map);
        
        // Listen for route changes when user drags the route
        directionsRenderer.addListener('directions_changed', function() {
            console.log('Route changed by user');
            updateRouteStates();
        });
        
        // Initialize autocomplete for origin and destination
        initAutocomplete();
        
        console.log('Google Maps initialized successfully');
    } catch (error) {
        console.error('Error initializing Google Maps:', error);
    }
}

// Initialize autocomplete for address inputs
function initAutocomplete() {
    // Create autocomplete objects for both inputs
    originAutocomplete = new google.maps.places.Autocomplete(
        document.getElementById('origin'),
        {
            componentRestrictions: { country: 'us' },
            fields: ['place_id', 'geometry', 'name', 'formatted_address']
        }
    );
    
    destinationAutocomplete = new google.maps.places.Autocomplete(
        document.getElementById('destination'),
        {
            componentRestrictions: { country: 'us' },
            fields: ['place_id', 'geometry', 'name', 'formatted_address']
        }
    );
    
    // Listen for place selection
    originAutocomplete.addListener('place_changed', function() {
        const place = originAutocomplete.getPlace();
        if (place.formatted_address) {
            document.getElementById('origin').value = place.formatted_address;
            calculateAndDisplayRoute();
        }
    });
    
    destinationAutocomplete.addListener('place_changed', function() {
        const place = destinationAutocomplete.getPlace();
        if (place.formatted_address) {
            document.getElementById('destination').value = place.formatted_address;
            calculateAndDisplayRoute();
        }
    });
}

// Calculate and display route on map
function calculateAndDisplayRoute() {
    const origin = document.getElementById('origin').value;
    const destination = document.getElementById('destination').value;
    
    if (origin && destination) {
        directionsService.route({
            origin: origin,
            destination: destination,
            travelMode: google.maps.TravelMode.DRIVING,
            avoidTolls: false,
            avoidHighways: false
        }, function(response, status) {
            if (status === 'OK') {
                directionsRenderer.setDirections(response);
                updateRouteStates();
            } else {
                console.error('Directions request failed due to ' + status);
            }
        });
    }
}

// Update route states based on the current route
function updateRouteStates() {
    if (!directionsRenderer.getDirections()) return;
    
    const route = directionsRenderer.getDirections().routes[0];
    if (!route) return;
    
    // Extract states from the route legs
    const routeStates = new Set();
    
    // Simple state detection based on origin and destination addresses
    const origin = document.getElementById('origin').value;
    const destination = document.getElementById('destination').value;
    
    // Extract state codes from addresses
    const originState = extractStateFromAddress(origin);
    const destState = extractStateFromAddress(destination);
    
    if (originState) routeStates.add(originState);
    if (destState) routeStates.add(destState);
    
    // For more complex route analysis, we would need to geocode points along the route
    // For now, let's suggest users manually select states they pass through
    
    if (routeStates.size > 0) {
        console.log('Detected states:', Array.from(routeStates));
        
        // Auto-select detected states
        document.querySelectorAll('.state-option').forEach(option => {
            const state = option.dataset.state;
            if (routeStates.has(state)) {
                if (!option.classList.contains('selected')) {
                    option.classList.add('selected');
                    if (!selectedStates.includes(state)) {
                        selectedStates.push(state);
                    }
                }
            }
        });
        
        updateRouteDisplay();
    }
}

// Extract state code from address string
function extractStateFromAddress(address) {
    if (!address) return null;
    
    const stateRegex = /\b(AL|AK|AZ|AR|CA|CO|CT|DE|FL|GA|HI|ID|IL|IN|IA|KS|KY|LA|ME|MD|MA|MI|MN|MS|MO|MT|NE|NV|NH|NJ|NM|NY|NC|ND|OH|OK|OR|PA|RI|SC|SD|TN|TX|UT|VT|VA|WA|WV|WI|WY)\b/i;
    const match = address.match(stateRegex);
    return match ? match[1].toUpperCase() : null;
}

// Auto-detect states button handler
function autoDetectStates() {
    const origin = document.getElementById('origin').value;
    const destination = document.getElementById('destination').value;
    
    if (!origin || !destination) {
        alert('Please enter both origin and destination first');
        return;
    }
    
    // Clear current selection
    clearRoute();
    
    // Trigger route calculation which will auto-select states
    calculateAndDisplayRoute();
    
    // Show a helpful message
    setTimeout(() => {
        if (selectedStates.length > 0) {
            alert(`Detected ${selectedStates.length} states in your route: ${selectedStates.join(', ')}\n\nYou can manually add or remove states as needed.`);
        }
    }, 1000);
}

// State data for search functionality
const stateData = [
    { code: 'AL', name: 'Alabama' }, { code: 'AK', name: 'Alaska' }, { code: 'AZ', name: 'Arizona' },
    { code: 'AR', name: 'Arkansas' }, { code: 'CA', name: 'California' }, { code: 'CO', name: 'Colorado' },
    { code: 'CT', name: 'Connecticut' }, { code: 'DE', name: 'Delaware' }, { code: 'FL', name: 'Florida' },
    { code: 'GA', name: 'Georgia' }, { code: 'HI', name: 'Hawaii' }, { code: 'ID', name: 'Idaho' },
    { code: 'IL', name: 'Illinois' }, { code: 'IN', name: 'Indiana' }, { code: 'IA', name: 'Iowa' },
    { code: 'KS', name: 'Kansas' }, { code: 'KY', name: 'Kentucky' }, { code: 'LA', name: 'Louisiana' },
    { code: 'ME', name: 'Maine' }, { code: 'MD', name: 'Maryland' }, { code: 'MA', name: 'Massachusetts' },
    { code: 'MI', name: 'Michigan' }, { code: 'MN', name: 'Minnesota' }, { code: 'MS', name: 'Mississippi' },
    { code: 'MO', name: 'Missouri' }, { code: 'MT', name: 'Montana' }, { code: 'NE', name: 'Nebraska' },
    { code: 'NV', name: 'Nevada' }, { code: 'NH', name: 'New Hampshire' }, { code: 'NJ', name: 'New Jersey' },
    { code: 'NM', name: 'New Mexico' }, { code: 'NY', name: 'New York' }, { code: 'NC', name: 'North Carolina' },
    { code: 'ND', name: 'North Dakota' }, { code: 'OH', name: 'Ohio' }, { code: 'OK', name: 'Oklahoma' },
    { code: 'OR', name: 'Oregon' }, { code: 'PA', name: 'Pennsylvania' }, { code: 'RI', name: 'Rhode Island' },
    { code: 'SC', name: 'South Carolina' }, { code: 'SD', name: 'South Dakota' }, { code: 'TN', name: 'Tennessee' },
    { code: 'TX', name: 'Texas' }, { code: 'UT', name: 'Utah' }, { code: 'VT', name: 'Vermont' },
    { code: 'VA', name: 'Virginia' }, { code: 'WA', name: 'Washington' }, { code: 'WV', name: 'West Virginia' },
    { code: 'WI', name: 'Wisconsin' }, { code: 'WY', name: 'Wyoming' }
];

// State selection functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing...');
    
    // Check if calculate button exists
    const calculateBtn = document.querySelector('button[onclick="calculateRoute()"]');
    if (calculateBtn) {
        console.log('Calculate button found');
    } else {
        console.error('Calculate button not found!');
    }
    
    // Initialize state search functionality
    initStateSearch();
    
    // Add event listeners for manual route calculation
    document.getElementById('origin').addEventListener('blur', calculateAndDisplayRoute);
    document.getElementById('destination').addEventListener('blur', calculateAndDisplayRoute);
});

// Initialize state search functionality
function initStateSearch() {
    const searchInput = document.getElementById('state-search');
    const suggestionsDiv = document.getElementById('state-suggestions');
    
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        
        if (query.length === 0) {
            suggestionsDiv.style.display = 'none';
            return;
        }
        
        const filteredStates = stateData.filter(state => 
            state.code.toLowerCase().includes(query) || 
            state.name.toLowerCase().includes(query)
        );
        
        if (filteredStates.length > 0) {
            suggestionsDiv.innerHTML = filteredStates.map(state => 
                `<div class="state-suggestion-item" data-state="${state.code}">${state.code} - ${state.name}</div>`
            ).join('');
            suggestionsDiv.style.display = 'block';
            
            // Ensure the input is visible
            searchInput.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            suggestionsDiv.style.display = 'none';
        }
    });
    
    // Handle suggestion clicks
    suggestionsDiv.addEventListener('click', function(e) {
        if (e.target.classList.contains('state-suggestion-item')) {
            const stateCode = e.target.dataset.state;
            addState(stateCode);
            searchInput.value = '';
            suggestionsDiv.style.display = 'none';
        }
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
            suggestionsDiv.style.display = 'none';
        }
    });
    
    // Handle enter key and prevent scroll jumps
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            e.stopPropagation();
            const firstSuggestion = suggestionsDiv.querySelector('.state-suggestion-item');
            if (firstSuggestion) {
                firstSuggestion.click();
            }
            return false;
        }
    });
}

// Add a state to the selection
function addState(stateCode) {
    if (!selectedStates.includes(stateCode)) {
        selectedStates.push(stateCode);
        updateRouteDisplay();
    }
}

function updateRouteDisplay() {
    const routeDisplay = document.getElementById('route-display');
    const selectedRoute = document.getElementById('selected-route');
    
    if (selectedStates.length > 0) {
        const statesBadges = selectedStates.map((state, index) => 
            `<span class="badge bg-primary me-1 mb-1">${state} <button type="button" class="btn-close btn-close-white ms-1" onclick="removeState('${state}')" style="font-size: 0.7em;"></button></span>`
        ).join('');
        routeDisplay.innerHTML = statesBadges;
        selectedRoute.style.display = 'block';
    } else {
        selectedRoute.style.display = 'none';
    }
}

// Remove a state from selection
function removeState(stateCode) {
    selectedStates = selectedStates.filter(s => s !== stateCode);
    updateRouteDisplay();
}

function clearRoute() {
    selectedStates = [];
    document.querySelectorAll('.state-option.selected').forEach(option => {
        option.classList.remove('selected');
    });
    updateRouteDisplay();
}

function resetMap() {
    if (map) {
        map.setCenter({ lat: 38.9072, lng: -77.0369 });
        map.setZoom(6);
        if (directionsRenderer) {
            directionsRenderer.setDirections({ routes: [] });
        }
    }
}

function calculateRoute() {
    // Validate form
    const origin = document.getElementById('origin').value;
    const destination = document.getElementById('destination').value;
    const width = document.getElementById('width').value;
    const height = document.getElementById('height').value;
    const length = document.getElementById('length').value;
    const weight = document.getElementById('weight').value;
    
    if (!origin || !destination || !width || !height || !length || !weight) {
        alert('Please fill in all required fields (origin, destination, and all dimensions)');
        return;
    }
    
    if (selectedStates.length === 0) {
        alert('Please select at least one state for your route. Use the "Auto-Detect Route States" button or manually search and add states.');
        return;
    }
    
    // Get road type
    const roadType = document.querySelector('input[name="road_type"]:checked').value;
    
    // Prepare data
    const routeData = {
        origin: origin,
        destination: destination,
        road_type: roadType,
        width: parseFloat(width),
        height: parseFloat(height),
        length: parseFloat(length),
        weight: parseFloat(weight),
        front_overhang: parseFloat(document.getElementById('front_overhang').value || 0),
        rear_overhang: parseFloat(document.getElementById('rear_overhang').value || 0),
        custom_route: selectedStates
    };
    
    // Show loading
    document.getElementById('loading').style.display = 'block';
    document.getElementById('results-section').style.display = 'none';
    
    // Make API call
    fetch('/calculate-route', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(routeData)
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loading').style.display = 'none';
        
        if (data.success) {
            displayResults(data);
            currentResults = data;
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        document.getElementById('loading').style.display = 'none';
        alert('Error calculating route: ' + error);
    });
}

function displayResults(data) {
    // Update route summary with dimensions
    const summaryContent = document.getElementById('summary-content');
    const loadData = getCurrentLoadData();
    
    summaryContent.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <p><strong>Origin:</strong> ${data.route_summary.origin}</p>
                <p><strong>Destination:</strong> ${data.route_summary.destination}</p>
                <p><strong>Road Type:</strong> ${data.route_summary.road_type}</p>
                <p class="route-path"><strong>States:</strong> ${data.route_summary.states}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Dimensions:</strong></p>
                <ul class="list-unstyled ms-3">
                    <li>Length: ${loadData.length} ft</li>
                    <li>Width: ${loadData.width} ft</li>
                    <li>Height: ${loadData.height} ft</li>
                    <li>Weight: ${loadData.weight.toLocaleString()} lbs</li>
                    ${loadData.front_overhang > 0 ? `<li>Front Overhang: ${loadData.front_overhang} ft</li>` : ''}
                    ${loadData.rear_overhang > 0 ? `<li>Rear Overhang: ${loadData.rear_overhang} ft</li>` : ''}
                </ul>
            </div>
        </div>
    `;
    
    // Update results table
    const tbody = document.getElementById('results-tbody');
    tbody.innerHTML = '';
    
    data.results.forEach(result => {
        const escortInfo = processEscortRequirements(result.escort_requirements);
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><span class="state-badge">${result.state}</span></td>
            <td>${result.road_type}</td>
            <td>${escortInfo.routeSurvey ? '<span class="badge badge-yes">Yes</span>' : '<span class="badge badge-no">No</span>'}</td>
            <td>${escortInfo.policeEscort ? '<span class="badge badge-yes">Yes</span>' : '<span class="badge badge-no">No</span>'}</td>
            <td>${getEscortBadge(escortInfo.finalRequirements)}</td>
            <td class="notes-cell">${result.notes}</td>
        `;
        tbody.appendChild(row);
    });
    
    // Show results
    document.getElementById('results-section').style.display = 'block';
}

// Get current load data from form
function getCurrentLoadData() {
    return {
        length: parseFloat(document.getElementById('length').value || 0),
        width: parseFloat(document.getElementById('width').value || 0),
        height: parseFloat(document.getElementById('height').value || 0),
        weight: parseFloat(document.getElementById('weight').value || 0),
        front_overhang: parseFloat(document.getElementById('front_overhang').value || 0),
        rear_overhang: parseFloat(document.getElementById('rear_overhang').value || 0)
    };
}

// Process escort requirements with High Pole logic
function processEscortRequirements(requirements) {
    if (!requirements || requirements === 'None Required') {
        return {
            routeSurvey: false,
            policeEscort: false,
            finalRequirements: 'None Required'
        };
    }
    
    const reqString = requirements.toLowerCase();
    const routeSurvey = reqString.includes('route survey');
    const policeEscort = reqString.includes('police');
    
    // Parse individual escort requirements
    let hasRear = reqString.includes('rear');
    let hasFront = reqString.includes('front');
    let hasHP = reqString.includes('high pole') || reqString.includes('hp');
    
    // Apply High Pole logic: HP replaces Front
    if (hasHP && hasFront) {
        hasFront = false; // HP replaces front
    }
    
    // Build final requirements
    const finalReqs = [];
    if (hasHP) finalReqs.push('High Pole');
    if (hasFront) finalReqs.push('Front');
    if (hasRear) finalReqs.push('Rear');
    
    return {
        routeSurvey,
        policeEscort,
        finalRequirements: finalReqs.length > 0 ? finalReqs.join(', ') : 'None Required'
    };
}

function getEscortBadge(requirements) {
    if (requirements === 'None Required') {
        return '<span class="escort-badge escort-none">None Required</span>';
    }
    
    const badges = requirements.split(', ').map(req => {
        const reqLower = req.toLowerCase();
        let className = 'escort-badge';
        
        if (reqLower.includes('high pole')) {
            className += ' escort-hp';
        } else if (reqLower.includes('front')) {
            className += ' escort-front';
        } else if (reqLower.includes('rear')) {
            className += ' escort-rear';
        } else if (reqLower.includes('police')) {
            className += ' escort-police';
        } else {
            className += ' escort-other';
        }
        
        return `<span class="${className}">${req}</span>`;
    });
    
    return badges.join(' ');
}

function saveRoute() {
    const routeName = document.getElementById('route-name').value;
    if (!routeName) {
        alert('Please enter a route name');
        return;
    }
    
    if (!currentResults) {
        alert('Please calculate a route first');
        return;
    }
    
    const saveData = {
        route_name: routeName,
        origin: document.getElementById('origin').value,
        destination: document.getElementById('destination').value,
        road_type: document.querySelector('input[name="road_type"]:checked').value,
        width: parseFloat(document.getElementById('width').value),
        height: parseFloat(document.getElementById('height').value),
        length: parseFloat(document.getElementById('length').value),
        weight: parseFloat(document.getElementById('weight').value),
        front_overhang: parseFloat(document.getElementById('front_overhang').value || 0),
        rear_overhang: parseFloat(document.getElementById('rear_overhang').value || 0),
        custom_route: selectedStates,
        results: currentResults.results
    };
    
    fetch('/save-route', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(saveData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Route saved successfully!');
            document.getElementById('route-name').value = '';
        } else {
            alert('Error saving route: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error saving route: ' + error);
    });
}
</script>
{% endblock %} 