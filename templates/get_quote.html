﻿﻿﻿{% extends "base.html" %}

{% block title %}Load Planning & Route Analysis - Pilot Car Services | Pilot Cars & Permits{% endblock %}

{% block meta_description %}Professional load planning and route analysis for oversized loads. Calculate escort requirements, compliance needs, and optimal routes across all 50 states. Contact us for personalized pricing.{% endblock %}

{% block meta_keywords %}load planning, route analysis, oversized load planning, escort requirements, DOT compliance, load calculation, route survey, freight planning, heavy haul planning{% endblock %}

{% block og_title %}Load Planning & Route Analysis - Pilot Cars & Permits{% endblock %}
{% block og_description %}Professional load planning and route analysis for oversized loads. Calculate escort requirements and compliance needs across all 50 states.{% endblock %}

{% block extra_head %}
<style>
  .quote-card {
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    background-color: #fff;
  }
  .section-heading {
    border-bottom: 2px solid #eee;
    padding-bottom: 10px;
    margin-bottom: 20px;
  }
  .form-check-input:checked {
    background-color: var(--pp-primary);
    border-color: var(--pp-primary);
  }
  .quote-result {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-left: 4px solid #28a745;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row">
    <div class="col-12">
      <h2><i class="fas fa-dollar-sign me-2"></i>Get A Quote</h2>
      <p class="text-muted">Generate an accurate estimate for pilot car escort services</p>
    </div>
  </div>

  <div class="row mt-3">
    <div class="col-lg-8">
      <div class="quote-card p-4">
        <form id="quoteForm">
          <!-- Trip Information -->
          <h4 class="section-heading"><i class="fas fa-map-marker-alt me-2"></i>Trip Information</h4>
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="pickupDate" class="form-label">Pickup Date *</label>
                <input type="date" class="form-control" id="pickupDate" name="pickup_date" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="pickupTime" class="form-label">Pickup Time *</label>
                <input type="time" class="form-control" id="pickupTime" name="pickup_time" required>
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="pickupLocation" class="form-label">Pickup Location (City) *</label>
                <input type="text" class="form-control" id="pickupLocation" name="pickup_location" placeholder="Enter city name" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="pickupState" class="form-label">Pickup State *</label>
                <select class="form-select" id="pickupState" name="pickup_state" required>
                  <option value="">Select state...</option>
                </select>
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="deliveryLocation" class="form-label">Delivery Location (City) *</label>
                <input type="text" class="form-control" id="deliveryLocation" name="delivery_location" placeholder="Enter city name" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="deliveryState" class="form-label">Delivery State *</label>
                <select class="form-select" id="deliveryState" name="delivery_state" required>
                  <option value="">Select state...</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Service Requirements -->
          <h4 class="section-heading"><i class="fas fa-truck me-2"></i>Service Requirements</h4>
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Car Type Selection *</label>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="Lead / Chase" id="leadChase" name="car_types[]">
                  <label class="form-check-label" for="leadChase">
                    <strong>Lead / Chase</strong>
                    <small class="text-muted d-block">Standard escort vehicle</small>
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="High Pole" id="highPole" name="car_types[]">
                  <label class="form-check-label" for="highPole">
                    <strong>High Pole</strong>
                    <small class="text-muted d-block">For height clearance checking</small>
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="Steerman" id="steerman" name="car_types[]">
                  <label class="form-check-label" for="steerman">
                    <strong>Steerman</strong>
                    <small class="text-muted d-block">For wide load steering assistance</small>
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="Route Survey" id="routeSurvey" name="car_types[]">
                  <label class="form-check-label" for="routeSurvey">
                    <strong>Route Survey</strong>
                    <small class="text-muted d-block">Pre-trip route assessment</small>
                  </label>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Additional Options</label>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="1" id="superload" name="is_superload">
                  <label class="form-check-label" for="superload">
                    <strong>Superload</strong>
                    <small class="form-text text-muted d-block">Check if this is a superload that requires special handling and premium rates</small>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="text-end">
            <button type="button" id="calculateButton" class="btn btn-success btn-lg">
              <i class="fas fa-calculator me-2"></i>Calculate Quote
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="quote-card p-4">
        <h4><i class="fas fa-info-circle me-2"></i>Quote Information</h4>
        
        <div id="quoteLoading" class="text-center py-5 d-none">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3">Calculating your quote...</p>
        </div>
        
        <div id="quoteResult" class="d-none">
          <div class="alert alert-info mb-3">
            <small><i class="fas fa-info-circle me-1"></i> This is an estimate based on the information provided. Actual rates may vary based on specific conditions.</small>
          </div>
          
          <div class="quote-result p-3 rounded mb-3">
            <div class="row">
              <div class="col-6">
                <label class="fw-bold text-muted">Distance:</label>
                <p class="mb-0" id="distance"></p>
              </div>
              <div class="col-6">
                <label class="fw-bold text-muted">Rate Type:</label>
                <p class="mb-0" id="rateType"></p>
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-6">
                <label class="fw-bold text-muted">Trip Duration:</label>
                <p class="mb-0" id="tripDays"></p>
              </div>
              <div class="col-6">
                <label class="fw-bold text-muted">Region:</label>
                <p class="mb-0" id="region"></p>
              </div>
            </div>
          </div>
          
          <div class="text-center mb-3">
            <label class="fw-bold text-muted">Total Estimated Cost:</label>
            <h3 class="text-success mb-0" id="totalCost"></h3>
          </div>
          
          <div id="breakdownSection">
            <h5 class="mt-4 mb-3">Cost Breakdown</h5>
            <div id="costBreakdown"></div>
          </div>
          
          <div class="text-center mt-4">
            <div class="row">
              <div class="col-6">
                <button type="button" id="saveQuoteButton" class="btn btn-primary w-100">
                  <i class="fas fa-save me-2"></i>Save Quote
                </button>
              </div>
              <div class="col-6">
                <button type="button" id="orderPilotCarBtn" class="btn btn-warning w-100" onclick="orderPilotCarFromQuote()">
                  <i class="fas fa-car me-2"></i>Order Pilot Car
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div id="quoteInitial" class="text-center py-5">
          <i class="fas fa-file-invoice-dollar text-muted" style="font-size: 3rem;"></i>
          <p class="mt-3 text-muted">Fill out the form to get a quote</p>
          <div class="mt-4">
            <h6 class="text-muted">Quick Tips:</h6>
            <ul class="list-unstyled small text-muted">
              <li><i class="fas fa-check-circle text-success me-1"></i> Select pickup date for accurate rates</li>
              <li><i class="fas fa-check-circle text-success me-1"></i> Choose appropriate car types</li>
              <li><i class="fas fa-check-circle text-success me-1"></i> Mark superload if applicable</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB7POzdvk3ri7buWrkOLV7nNZK8pSeOxao&libraries=places"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // State dropdown options
    const states = [
      { code: 'AL', name: 'Alabama' }, { code: 'AK', name: 'Alaska' }, { code: 'AZ', name: 'Arizona' },
      { code: 'AR', name: 'Arkansas' }, { code: 'CA', name: 'California' }, { code: 'CO', name: 'Colorado' },
      { code: 'CT', name: 'Connecticut' }, { code: 'DE', name: 'Delaware' }, { code: 'FL', name: 'Florida' },
      { code: 'GA', name: 'Georgia' }, { code: 'HI', name: 'Hawaii' }, { code: 'ID', name: 'Idaho' },
      { code: 'IL', name: 'Illinois' }, { code: 'IN', name: 'Indiana' }, { code: 'IA', name: 'Iowa' },
      { code: 'KS', name: 'Kansas' }, { code: 'KY', name: 'Kentucky' }, { code: 'LA', name: 'Louisiana' },
      { code: 'ME', name: 'Maine' }, { code: 'MD', name: 'Maryland' }, { code: 'MA', name: 'Massachusetts' },
      { code: 'MI', name: 'Michigan' }, { code: 'MN', name: 'Minnesota' }, { code: 'MS', name: 'Mississippi' },
      { code: 'MO', name: 'Missouri' }, { code: 'MT', name: 'Montana' }, { code: 'NE', name: 'Nebraska' },
      { code: 'NV', name: 'Nevada' }, { code: 'NH', name: 'New Hampshire' }, { code: 'NJ', name: 'New Jersey' },
      { code: 'NM', name: 'New Mexico' }, { code: 'NY', name: 'New York' }, { code: 'NC', name: 'North Carolina' },
      { code: 'ND', name: 'North Dakota' }, { code: 'OH', name: 'Ohio' }, { code: 'OK', name: 'Oklahoma' },
      { code: 'OR', name: 'Oregon' }, { code: 'PA', name: 'Pennsylvania' }, { code: 'RI', name: 'Rhode Island' },
      { code: 'SC', name: 'South Carolina' }, { code: 'SD', name: 'South Dakota' }, { code: 'TN', name: 'Tennessee' },
      { code: 'TX', name: 'Texas' }, { code: 'UT', name: 'Utah' }, { code: 'VT', name: 'Vermont' },
      { code: 'VA', name: 'Virginia' }, { code: 'WA', name: 'Washington' }, { code: 'WV', name: 'West Virginia' },
      { code: 'WI', name: 'Wisconsin' }, { code: 'WY', name: 'Wyoming' }
    ];

    // Populate state dropdowns
    const pickupState = document.getElementById('pickupState');
    const deliveryState = document.getElementById('deliveryState');

    states.forEach(state => {
      const pickupOption = document.createElement('option');
      pickupOption.value = state.code;
      pickupOption.textContent = state.name;
      pickupState.appendChild(pickupOption);

      const deliveryOption = document.createElement('option');
      deliveryOption.value = state.code;
      deliveryOption.textContent = state.name;
      deliveryState.appendChild(deliveryOption);
    });

    // Google Places Autocomplete
    const pickupLocationInput = document.getElementById('pickupLocation');
    const deliveryLocationInput = document.getElementById('deliveryLocation');
    
    // Create autocomplete instances with enhanced place data
    const pickupAutocomplete = new google.maps.places.Autocomplete(pickupLocationInput, {
      types: ['(cities)'],
      componentRestrictions: { country: 'us' },
      fields: ['place_id', 'formatted_address', 'address_components', 'name']
    });
    
    const deliveryAutocomplete = new google.maps.places.Autocomplete(deliveryLocationInput, {
      types: ['(cities)'],
      componentRestrictions: { country: 'us' },
      fields: ['place_id', 'formatted_address', 'address_components', 'name']
    });

    // Function to extract state from address components
    function extractStateFromPlace(place) {
      if (!place.address_components) return null;
      
      for (const component of place.address_components) {
        if (component.types.includes('administrative_area_level_1')) {
          return component.short_name; // Returns state abbreviation like 'CA', 'TX', etc.
        }
      }
      return null;
    }

    // Auto-set state when pickup location is selected
    pickupAutocomplete.addListener('place_changed', function() {
      const place = pickupAutocomplete.getPlace();
      if (place && place.address_components) {
        const state = extractStateFromPlace(place);
        if (state) {
          document.getElementById('pickupState').value = state;
        }
        // Set the clean city name
        if (place.name) {
          pickupLocationInput.value = place.name;
        }
      }
    });

    // Auto-set state when delivery location is selected
    deliveryAutocomplete.addListener('place_changed', function() {
      const place = deliveryAutocomplete.getPlace();
      if (place && place.address_components) {
        const state = extractStateFromPlace(place);
        if (state) {
          document.getElementById('deliveryState').value = state;
        }
        // Set the clean city name
        if (place.name) {
          deliveryLocationInput.value = place.name;
        }
      }
    });

    // Check for URL parameters (for quote duplication)
    const urlParams = new URLSearchParams(window.location.search);
    
    // Pre-fill form if duplicating a quote
    if (urlParams.get('duplicate')) {
      // Pre-fill basic fields
      if (urlParams.get('pickup_location')) {
        document.getElementById('pickupLocation').value = urlParams.get('pickup_location');
      }
      if (urlParams.get('pickup_state')) {
        document.getElementById('pickupState').value = urlParams.get('pickup_state');
      }
      if (urlParams.get('delivery_location')) {
        document.getElementById('deliveryLocation').value = urlParams.get('delivery_location');
      }
      if (urlParams.get('delivery_state')) {
        document.getElementById('deliveryState').value = urlParams.get('delivery_state');
      }
      if (urlParams.get('pickup_date')) {
        document.getElementById('pickupDate').value = urlParams.get('pickup_date').replace(/-/g, '-');
      }
      if (urlParams.get('pickup_time')) {
        document.getElementById('pickupTime').value = urlParams.get('pickup_time');
      }
      
      // Pre-fill car types
      if (urlParams.get('car_types')) {
        try {
          const carTypes = JSON.parse(decodeURIComponent(urlParams.get('car_types')));
          carTypes.forEach(carType => {
            const checkbox = document.querySelector(`input[value="${carType}"]`);
            if (checkbox) {
              checkbox.checked = true;
            }
          });
        } catch (e) {
          console.error('Error parsing car types:', e);
        }
      }
      
      // Pre-fill superload
      if (urlParams.get('is_superload') === 'true') {
        document.getElementById('superload').checked = true;
      }
      
      // Show banner that this is a duplicate
      const duplicateBanner = document.createElement('div');
      duplicateBanner.className = 'alert alert-info alert-dismissible fade show mt-3';
      duplicateBanner.innerHTML = `
        <i class="fas fa-copy me-2"></i>
        <strong>Duplicating Quote #${urlParams.get('duplicate')}</strong> - Form has been pre-filled with the original quote data.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.querySelector('.container .row .col-12').appendChild(duplicateBanner);
    } else {
      // Set default date to tomorrow only if not duplicating
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('pickupDate').value = tomorrow.toISOString().split('T')[0];
    }

    // Calculate button click event
    document.getElementById('calculateButton').addEventListener('click', function() {
      // Validate form
      const form = document.getElementById('quoteForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      // Check if at least one car type is selected
      const carTypes = [];
      document.querySelectorAll('input[name="car_types[]"]').forEach(checkbox => {
        if (checkbox.checked) {
          carTypes.push(checkbox.value);
        }
      });

      if (carTypes.length === 0) {
        alert('Please select at least one car type');
        return;
      }

      // Show loading
      document.getElementById('quoteInitial').classList.add('d-none');
      document.getElementById('quoteResult').classList.add('d-none');
      document.getElementById('quoteLoading').classList.remove('d-none');

      // Prepare data
      const data = {
        pickup_date: document.getElementById('pickupDate').value,
        pickup_time: document.getElementById('pickupTime').value,
        pickup_location: document.getElementById('pickupLocation').value,
        pickup_state: document.getElementById('pickupState').value,
        delivery_location: document.getElementById('deliveryLocation').value,
        delivery_state: document.getElementById('deliveryState').value,
        car_types: carTypes,
        is_superload: document.getElementById('superload').checked
      };

      // Send request
      fetch('/calculate-quote', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          displayQuoteResult(result.result);
          // Store quote ID for saving
          window.currentQuoteId = result.quote_id;
        } else {
          alert('Error: ' + (result.error || 'Failed to calculate quote'));
          document.getElementById('quoteInitial').classList.remove('d-none');
          document.getElementById('quoteLoading').classList.add('d-none');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while calculating the quote');
        document.getElementById('quoteInitial').classList.remove('d-none');
        document.getElementById('quoteLoading').classList.add('d-none');
      });
    });

    // Save quote button
    document.getElementById('saveQuoteButton').addEventListener('click', function() {
      if (window.currentQuoteId) {
        alert('Quote saved successfully!');
        // Optionally redirect to My Quotes page
        // window.location.href = '/my-quotes';
      } else {
        alert('Please calculate a quote first');
      }
    });

    function displayQuoteResult(result) {
      // Format currency
      const formatCurrency = (amount) => {
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD'
        }).format(amount);
      };

      // Update result fields
      document.getElementById('distance').textContent = result.distance + ' miles';
      document.getElementById('rateType').innerHTML = `<span class="badge bg-${result.rate_type === 'premium' ? 'warning' : 'success'}">${result.rate_type.charAt(0).toUpperCase() + result.rate_type.slice(1)}</span>`;
      document.getElementById('tripDays').textContent = result.trip_days + ' day' + (result.trip_days > 1 ? 's' : '');
      document.getElementById('region').textContent = result.region;
      document.getElementById('totalCost').textContent = formatCurrency(result.total_cost);

      // Generate breakdown
      const breakdownContainer = document.getElementById('costBreakdown');
      breakdownContainer.innerHTML = '';

      for (const [carType, details] of Object.entries(result.breakdown)) {
        const carTypeDiv = document.createElement('div');
        carTypeDiv.classList.add('mb-3', 'p-3', 'bg-light', 'rounded');
        
        carTypeDiv.innerHTML = `
          <h6 class="fw-bold">${carType}</h6>
          <div class="row">
            <div class="col-6">
              <small class="text-muted">Rate: ${formatCurrency(details.mile_rate)}/mile</small>
            </div>
            <div class="col-6">
              <small class="text-muted">Day Rate: ${formatCurrency(details.day_rate)}</small>
            </div>
          </div>
          <div class="mt-2">
            <strong>Total: ${formatCurrency(details.total)}</strong>
          </div>
        `;

        breakdownContainer.appendChild(carTypeDiv);
      }

      // Show result
      document.getElementById('quoteLoading').classList.add('d-none');
      document.getElementById('quoteResult').classList.remove('d-none');
    }
  });

  // Function to order pilot car with pre-filled data from quote
  function orderPilotCarFromQuote() {
    // Check if quote has been calculated
    if (!window.currentQuoteId) {
      alert('Please calculate a quote first');
      return;
    }

    // Gather data from the quote form
    const carTypes = [];
    document.querySelectorAll('input[name="car_types[]"]:checked').forEach(checkbox => {
      carTypes.push(checkbox.value);
    });

    const quoteData = {
      pickup_address: document.getElementById('pickupLocation').value + ', ' + 
                     document.getElementById('pickupState').value,
      delivery_address: document.getElementById('deliveryLocation').value + ', ' + 
                       document.getElementById('deliveryState').value,
      pickup_date: document.getElementById('pickupDate').value,
      pickup_time: document.getElementById('pickupTime').value,
      pilot_car_positions: carTypes.join(','),
      is_superload: document.getElementById('superload').checked,
      quote_id: window.currentQuoteId
    };

    // Create URL with parameters
    const params = new URLSearchParams();
    Object.keys(quoteData).forEach(key => {
      if (quoteData[key]) {
        params.append(key, quoteData[key]);
      }
    });

    // Navigate to order pilot car page with pre-filled data
    window.location.href = `/order-pilot-car?source=quote&${params.toString()}`;
  }
</script>
{% endblock %}
