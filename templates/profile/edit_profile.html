﻿﻿﻿﻿﻿﻿{% extends "base.html" %}

{% block title %}Edit Profile - Pilot Cars & Permits{% endblock %}

{% block extra_css %}
<style>
    .edit-profile-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
    }
    
    .form-card {
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border-radius: 15px;
        overflow: hidden;
    }
    
    .form-card .card-header {
        background: linear-gradient(45deg, #f8f9fa, #e9ecef);
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .form-control {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
    
    .btn-save {
        background: linear-gradient(45deg, #28a745, #20c997);
        border: none;
        border-radius: 25px;
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
    }
    
    .btn-cancel {
        background: linear-gradient(45deg, #6c757d, #5a6268);
        border: none;
        border-radius: 25px;
        padding: 0.75rem 2rem;
        font-weight: 600;
        color: white;
        transition: all 0.3s ease;
    }
    
    .btn-cancel:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        color: white;
    }
    
    .help-section {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 1.5rem;
        margin-top: 2rem;
    }
    
    .help-item {
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: white;
        border-radius: 8px;
        border-left: 4px solid #28a745;
    }
    
    .help-item:last-child {
        margin-bottom: 0;
    }
    
    .help-icon {
        color: #28a745;
        margin-right: 0.5rem;
    }
    
    .alert-custom {
        border: none;
        border-radius: 10px;
        padding: 1rem 1.5rem;
    }
    
    @media (max-width: 768px) {
        .edit-profile-header {
            padding: 1.5rem 0;
        }
        
        .btn-save, .btn-cancel {
            width: 100%;
            margin-bottom: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="edit-profile-header">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 text-center">
                <h1 class="mb-2">
                    <i class="fas fa-user-edit me-2"></i>
                    Edit Profile
                </h1>
                <p class="mb-0">Update your account information</p>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Success/Error Messages -->
            <div id="messageContainer"></div>
            
            <!-- Edit Profile Form -->
            <div class="card form-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user-circle me-2"></i>
                        Profile Information
                    </h5>
                </div>
                <div class="card-body">
                    <form id="editProfileForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="company_name" class="form-label">
                                        <i class="fas fa-building me-2"></i>
                                        Company Name *
                                    </label>
                                    <input type="text" class="form-control" id="company_name" name="company_name" 
                                           value="{{ user.company_name }}" required maxlength="100">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="contact_name" class="form-label">
                                        <i class="fas fa-user me-2"></i>
                                        Contact Name
                                    </label>
                                    <input type="text" class="form-control" id="contact_name" name="contact_name" 
                                           value="{{ user.contact_name if user.contact_name else '' }}" maxlength="100">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="email" class="form-label">
                                        <i class="fas fa-envelope me-2"></i>
                                        Email Address *
                                    </label>
                                    <input type="email" class="form-control" id="email" name="email" 
                                           value="{{ user.email }}" required maxlength="120">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="phone_number" class="form-label">
                                        <i class="fas fa-phone me-2"></i>
                                        Phone Number
                                    </label>
                                    <input type="tel" class="form-control" id="phone_number" name="phone_number" 
                                           value="{{ user.phone_number if user.phone_number else '' }}" maxlength="20">
                                </div>
                            </div>
                        </div>
                        
                        {% if user.user_type == 'trucking_company' %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="dot_number" class="form-label">
                                        <i class="fas fa-id-card me-2"></i>
                                        DOT Number
                                    </label>
                                    <input type="text" class="form-control" id="dot_number" name="dot_number" 
                                           value="{{ user.dot_number if user.dot_number else '' }}" maxlength="20">
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Required for trucking companies
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between flex-wrap">
                                    <div>
                                        <button type="button" class="btn btn-success btn-save" id="saveButton" onclick="submitProfileForm(); return false;">
                                            <i class="fas fa-save me-2"></i>
                                            Save Changes
                                        </button>

                                        <a href="{{ url_for('dashboard') }}" class="btn btn-cancel ms-2">
                                            <i class="fas fa-times me-2"></i>
                                            Cancel
                                        </a>
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                            <i class="fas fa-key me-2"></i>
                                            Change Password
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Help Section -->
            <div class="help-section">
                <h5 class="mb-3">
                    <i class="fas fa-question-circle me-2"></i>
                    Help & Guidelines
                </h5>
                
                <div class="help-item">
                    <i class="fas fa-check-circle help-icon"></i>
                    <strong>Required Fields:</strong> Company Name and Email Address are required fields.
                </div>
                
                <div class="help-item">
                    <i class="fas fa-envelope help-icon"></i>
                    <strong>Email Changes:</strong> Your email address is used for login and notifications.
                </div>
                
                <div class="help-item">
                    <i class="fas fa-phone help-icon"></i>
                    <strong>Phone Number:</strong> Include area code for better communication (e.g., +1-555-123-4567).
                </div>
                
                {% if user.user_type == 'trucking_company' %}
                <div class="help-item">
                    <i class="fas fa-truck help-icon"></i>
                    <strong>DOT Number:</strong> Your Department of Transportation number for compliance tracking.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changePasswordModalLabel">
                    <i class="fas fa-key me-2"></i>
                    Change Password
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="currentPassword" name="current_password" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword" name="new_password" required minlength="6">
                        <div class="form-text">Password must be at least 6 characters long.</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirm_password" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="changePassword()">
                    <i class="fas fa-save me-2"></i>
                    Change Password
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Handle profile form submission
function submitProfileForm() {
    // Profile form submission handler
    
    const form = document.getElementById('editProfileForm');
    if (!form) {
        // Form validation
        alert('Form not found!');
        return;
    }
    // Form found, processing data
    
    const formData = new FormData(form);
    const data = {};
    
    // Convert FormData to regular object
    for (let [key, value] of formData.entries()) {
        data[key] = value;
        // Building form data
    }
    
    // Sending profile update request
    
    // Disable button and show loading state
    const saveButton = document.getElementById('saveButton');
    saveButton.disabled = true;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
    
    // Making API request
    
    // Send AJAX request
    fetch('/profile/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        // Response received successfully
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // Processing response data
        const messageContainer = document.getElementById('messageContainer');
        
        if (data.success) {
            messageContainer.innerHTML = `
                <div class="alert alert-success alert-custom">
                    <i class="fas fa-check-circle me-2"></i>
                    ${data.message}
                </div>
            `;
            
            // Scroll to top to show message
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Don't redirect, let user see the success message
            // setTimeout(() => {
            //     window.location.href = '/profile';
            // }, 2000);
        } else {
            messageContainer.innerHTML = `
                <div class="alert alert-danger alert-custom">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    ${data.message}
                </div>
            `;
            
            // Scroll to top to show message
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        alert('Error: ' + error.message);
        document.getElementById('messageContainer').innerHTML = `
            <div class="alert alert-danger alert-custom">
                <i class="fas fa-exclamation-triangle me-2"></i>
                An error occurred while updating your profile. Please try again.
            </div>
        `;
        
        // Scroll to top to show message
        window.scrollTo({ top: 0, behavior: 'smooth' });
    })
    .finally(() => {
        // Reset button state
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="fas fa-save me-2"></i>Save Changes';
    });
}

// Test function - can be called from browser console
function testProfileUpdate() {
    // Testing profile update functionality
    submitProfileForm();
}



// Handle password change
function changePassword() {
    // Password change handler
    const form = document.getElementById('changePasswordForm');
    const formData = new FormData(form);
    
    // Validate passwords match
    const newPassword = formData.get('new_password');
    const confirmPassword = formData.get('confirm_password');
    
    if (newPassword !== confirmPassword) {
        alert('New passwords do not match!');
        return;
    }
    
    if (newPassword.length < 6) {
        alert('Password must be at least 6 characters long!');
        return;
    }
    
    console.log('Sending password change request');
    
    // Send AJAX request
    fetch('/profile/change-password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            current_password: formData.get('current_password'),
            new_password: newPassword,
            confirm_password: confirmPassword
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert('Password changed successfully!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
            if (modal) {
                modal.hide();
            }
            form.reset();
        } else {
            alert('Error: ' + (data.message || data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Password change error:', error);
        alert('An error occurred while changing password: ' + error.message);
    });
}
</script>
{% endblock %}
