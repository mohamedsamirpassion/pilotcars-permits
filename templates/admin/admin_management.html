{% extends "base.html" %}

{% block title %}Admin Management - Pilot Cars & Permits{% endblock %}

{% block extra_head %}
<style>
    .admin-management-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        color: white;
    }
    
    .header-title {
        margin: 0;
        font-size: 2rem;
        font-weight: 600;
    }
    
    .invite-admin-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .invite-admin-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        color: white;
        transform: translateY(-2px);
    }
    
    .admin-cards-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .admin-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border: 1px solid #e3e6f0;
        transition: all 0.3s ease;
    }
    
    .admin-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    }
    
    .admin-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .admin-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        font-weight: 600;
        margin-right: 15px;
    }
    
    .admin-info h5 {
        margin: 0;
        font-size: 1.3rem;
        color: #2c3e50;
        font-weight: 600;
    }
    
    .admin-info p {
        margin: 5px 0 0 0;
        color: #7f8c8d;
        font-size: 0.9rem;
    }
    
    .admin-details {
        margin-bottom: 20px;
    }
    
    .detail-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        font-size: 0.9rem;
    }
    
    .detail-item i {
        width: 20px;
        color: #667eea;
        margin-right: 10px;
    }
    
    .admin-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .action-btn {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
    }
    
    .btn-reset {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        color: white;
    }
    
    .btn-reset:hover {
        background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
        color: white;
        transform: translateY(-1px);
    }
    
    .btn-remove {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
    }
    
    .btn-remove:hover {
        background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
        color: white;
        transform: translateY(-1px);
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    .empty-state i {
        font-size: 4rem;
        color: #bdc3c7;
        margin-bottom: 20px;
    }
    
    .empty-state h3 {
        color: #2c3e50;
        margin-bottom: 10px;
    }
    
    .empty-state p {
        color: #7f8c8d;
        margin-bottom: 20px;
    }
    
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px 15px 0 0;
    }
    
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        transform: translateY(-1px);
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-management-container">
    <!-- Header Section -->
    <div class="header-section">
        <div>
            <h1 class="header-title">
                <i class="fas fa-users-cog me-3"></i>
                Admin Management
            </h1>
            <p class="mb-0 mt-2">Manage administrator accounts and permissions</p>
        </div>
        <button class="btn invite-admin-btn" data-bs-toggle="modal" data-bs-target="#inviteAdminModal">
            <i class="fas fa-user-plus me-2"></i>
            Invite Admin
        </button>
    </div>
    
    <!-- Message Container -->
    <div id="messageContainer"></div>
    
    <!-- Admin Cards -->
    {% if admin_users %}
        <div class="admin-cards-container">
            {% for admin in admin_users %}
            <div class="admin-card" data-admin-id="{{ admin.id }}">
                <div class="admin-header">
                    <div class="admin-avatar">
                        {{ admin.contact_name[0] if admin.contact_name else admin.company_name[0] }}
                    </div>
                    <div class="admin-info">
                        <h5>{{ admin.contact_name or 'Admin User' }}</h5>
                        <p>{{ admin.company_name }}</p>
                    </div>
                </div>
                
                <div class="admin-details">
                    <div class="detail-item">
                        <i class="fas fa-envelope"></i>
                        <span>{{ admin.email }}</span>
                    </div>
                    {% if admin.phone_number %}
                    <div class="detail-item">
                        <i class="fas fa-phone"></i>
                        <span>{{ admin.phone_number }}</span>
                    </div>
                    {% endif %}
                    <div class="detail-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Created {{ admin.created_at.strftime('%B %d, %Y') }}</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-shield-alt"></i>
                        <span class="badge bg-success">Administrator</span>
                    </div>
                </div>
                
                <div class="admin-actions">
                    <button class="action-btn btn-reset" onclick="resetAdminPassword({{ admin.id }}, '{{ admin.contact_name or admin.company_name }}')">
                        <i class="fas fa-key me-1"></i>
                        Reset Password
                    </button>
                    <button class="action-btn btn-remove" onclick="removeAdmin({{ admin.id }}, '{{ admin.contact_name or admin.company_name }}')">
                        <i class="fas fa-trash-alt me-1"></i>
                        Remove
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <i class="fas fa-users-cog"></i>
            <h3>No Admin Users</h3>
            <p>You haven't invited any administrators yet. Click the button above to invite your first admin user.</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#inviteAdminModal">
                <i class="fas fa-user-plus me-2"></i>
                Invite First Admin
            </button>
        </div>
    {% endif %}
</div>

<!-- Invite Admin Modal -->
<div class="modal fade" id="inviteAdminModal" tabindex="-1" aria-labelledby="inviteAdminModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inviteAdminModalLabel">
                    <i class="fas fa-user-plus me-2"></i>
                    Invite New Administrator
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="inviteAdminForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="companyName" class="form-label">Company/Organization Name</label>
                            <input type="text" class="form-control" id="companyName" name="company_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="contactName" class="form-label">Contact Name</label>
                            <input type="text" class="form-control" id="contactName" name="contact_name" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="phoneNumber" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phoneNumber" name="phone_number">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tempPassword" class="form-label">Temporary Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="tempPassword" name="temp_password" required minlength="6">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('tempPassword')">
                                    <i class="fas fa-eye" id="tempPasswordIcon"></i>
                                </button>
                            </div>
                            <div class="form-text">The admin user can change this password after their first login.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="adminRole" class="form-label">Admin Role</label>
                            <select class="form-control" id="adminRole" name="admin_role" required>
                                <option value="admin">Admin - Full access except admin management</option>
                                <option value="dispatcher">Dispatcher - Load planning and vendor locations only</option>
                            </select>
                            <div class="form-text">Choose the appropriate role based on responsibilities.</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Admin Permissions:</strong> The new administrator will have access to all admin features except managing other administrators.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitInviteAdmin()">
                    <i class="fas fa-user-plus me-2"></i>
                    Create Admin User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetPasswordModalLabel">
                    <i class="fas fa-key me-2"></i>
                    Reset Admin Password
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Reset password for: <strong id="resetAdminName"></strong></p>
                <form id="resetPasswordForm">
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="newPassword" name="new_password" required minlength="6">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('newPassword')">
                                <i class="fas fa-eye" id="newPasswordIcon"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="submitResetPassword()">
                    <i class="fas fa-key me-2"></i>
                    Reset Password
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentAdminId = null;

// Toggle password visibility
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + 'Icon');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        field.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Submit invite admin form
function submitInviteAdmin() {
    const form = document.getElementById('inviteAdminForm');
    const formData = new FormData(form);
    
    const data = {
        company_name: formData.get('company_name'),
        contact_name: formData.get('contact_name'),
        email: formData.get('email'),
        phone_number: formData.get('phone_number'),
        temp_password: formData.get('temp_password'),
        admin_role: formData.get('admin_role')
    };
    
    // Validate required fields
    if (!data.company_name || !data.contact_name || !data.email || !data.temp_password) {
        showMessage('Please fill in all required fields.', 'error');
        return;
    }
    
    // Validate password length
    if (data.temp_password.length < 6) {
        showMessage('Password must be at least 6 characters long.', 'error');
        return;
    }
    
    fetch('/admin/invite-admin', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('inviteAdminModal')).hide();
            form.reset();
            
            // Add new admin card to the page
            addAdminCard(data.admin);
        } else {
            showMessage(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('An error occurred while creating the admin user.', 'error');
    });
}

// Add new admin card to the page
function addAdminCard(admin) {
    const container = document.querySelector('.admin-cards-container');
    if (!container) {
        // If no container exists, remove empty state and create container
        const emptyState = document.querySelector('.empty-state');
        if (emptyState) {
            emptyState.remove();
        }
        
        const newContainer = document.createElement('div');
        newContainer.className = 'admin-cards-container';
        document.querySelector('.admin-management-container').appendChild(newContainer);
        container = newContainer;
    }
    
    const cardHtml = `
        <div class="admin-card" data-admin-id="${admin.id}">
            <div class="admin-header">
                <div class="admin-avatar">
                    ${admin.contact_name[0] || admin.company_name[0]}
                </div>
                <div class="admin-info">
                    <h5>${admin.contact_name || 'Admin User'}</h5>
                    <p>${admin.company_name}</p>
                </div>
            </div>
            
            <div class="admin-details">
                <div class="detail-item">
                    <i class="fas fa-envelope"></i>
                    <span>${admin.email}</span>
                </div>
                ${admin.phone_number ? `
                <div class="detail-item">
                    <i class="fas fa-phone"></i>
                    <span>${admin.phone_number}</span>
                </div>
                ` : ''}
                <div class="detail-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Created ${admin.created_at}</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-shield-alt"></i>
                    <span class="badge bg-success">Administrator</span>
                </div>
            </div>
            
            <div class="admin-actions">
                <button class="action-btn btn-reset" onclick="resetAdminPassword(${admin.id}, '${admin.contact_name || admin.company_name}')">
                    <i class="fas fa-key me-1"></i>
                    Reset Password
                </button>
                <button class="action-btn btn-remove" onclick="removeAdmin(${admin.id}, '${admin.contact_name || admin.company_name}')">
                    <i class="fas fa-trash-alt me-1"></i>
                    Remove
                </button>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', cardHtml);
}

// Reset admin password
function resetAdminPassword(adminId, adminName) {
    currentAdminId = adminId;
    document.getElementById('resetAdminName').textContent = adminName;
    new bootstrap.Modal(document.getElementById('resetPasswordModal')).show();
}

// Submit reset password
function submitResetPassword() {
    const newPassword = document.getElementById('newPassword').value;
    
    if (!newPassword || newPassword.length < 6) {
        showMessage('Password must be at least 6 characters long.', 'error');
        return;
    }
    
    fetch(`/admin/reset-admin-password/${currentAdminId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ new_password: newPassword })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal')).hide();
            document.getElementById('resetPasswordForm').reset();
        } else {
            showMessage(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('An error occurred while resetting the password.', 'error');
    });
}

// Remove admin
function removeAdmin(adminId, adminName) {
    if (confirm(`Are you sure you want to remove admin "${adminName}"? This action cannot be undone.`)) {
        fetch(`/admin/remove-admin/${adminId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, 'success');
                // Remove the admin card from the page
                const adminCard = document.querySelector(`[data-admin-id="${adminId}"]`);
                if (adminCard) {
                    adminCard.remove();
                }
                
                // Check if no admin cards left
                const remainingCards = document.querySelectorAll('.admin-card');
                if (remainingCards.length === 0) {
                    location.reload(); // Reload to show empty state
                }
            } else {
                showMessage(data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('An error occurred while removing the admin.', 'error');
        });
    }
}

// Show message function
function showMessage(message, type) {
    const messageContainer = document.getElementById('messageContainer');
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
    
    messageContainer.innerHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="fas ${icon} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        const alert = messageContainer.querySelector('.alert');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 5000);
}
</script>
{% endblock %} 