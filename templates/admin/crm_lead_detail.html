{% extends 'base.html' %}

{% block title %}Lead Details - {{ lead.company.company_name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-user-tie text-primary"></i> 
            Lead Details: {{ lead.company.company_name }}
        </h1>
        <div>
            <a href="{{ url_for('admin_crm_leads') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to All Leads
            </a>
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Lead Information -->
        <div class="col-md-8">
            <!-- Lead Overview -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Lead Overview</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Company:</strong></td>
                                    <td>{{ lead.company.company_name }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Contact Email:</strong></td>
                                    <td>{{ lead.company.email }}</td>
                                </tr>
                                {% if lead.company.phone_number %}
                                <tr>
                                    <td><strong>Phone:</strong></td>
                                    <td>{{ lead.company.phone_number }}</td>
                                </tr>
                                {% endif %}
                                {% if lead.company.dot_number %}
                                <tr>
                                    <td><strong>DOT Number:</strong></td>
                                    <td>{{ lead.company.dot_number }}</td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Lead Source:</strong></td>
                                    <td><span class="badge bg-secondary">{{ lead.lead_source.replace('_', ' ').title() }}</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Status:</strong></td>
                                    <td>
                                        {% if lead.status == 'pending' %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% elif lead.status == 'assigned' %}
                                            <span class="badge bg-info">Assigned</span>
                                        {% elif lead.status == 'in_progress' %}
                                            <span class="badge bg-primary">In Progress</span>
                                        {% elif lead.status == 'converted' %}
                                            <span class="badge bg-success">Converted</span>
                                        {% elif lead.status == 'lost' %}
                                            <span class="badge bg-danger">Lost</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Estimated Value:</strong></td>
                                    <td>
                                        {% if lead.estimated_value %}
                                            <span class="text-success">${{ "%.2f"|format(lead.estimated_value) }}</span>
                                        {% else %}
                                            <span class="text-muted">Not specified</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Assigned Admin:</strong></td>
                                    <td>
                                        {% if lead.assigned_admin %}
                                            {{ lead.assigned_admin.contact_name or lead.assigned_admin.company_name }}
                                            {% if lead.assigned_admin.id == current_user.id %}
                                                <span class="badge bg-success ms-1">You</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">Unassigned</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Created:</strong></td>
                                    <td>{{ lead.created_at.strftime('%m/%d/%Y %I:%M %p') }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Last Updated:</strong></td>
                                    <td>{{ lead.updated_at.strftime('%m/%d/%Y %I:%M %p') }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lead Data -->
            {% if lead_data %}
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-database"></i> Service Details</h5>
                </div>
                <div class="card-body">
                    {% if lead_data.activities %}
                        {% for activity in lead_data.activities %}
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <strong>{{ activity.source.replace('_', ' ').title() }} Activity</strong>
                                <small class="text-muted ms-2">{{ activity.timestamp }}</small>
                            </div>
                            <div class="card-body">
                                {% if activity.data %}
                                    {% for key, value in activity.data.items() %}
                                        {% if key != 'load_dimensions' %}
                                        <p><strong>{{ key.replace('_', ' ').title() }}:</strong> 
                                        {% if value is mapping %}
                                            <ul>
                                            {% for k, v in value.items() %}
                                                <li>{{ k.replace('_', ' ').title() }}: {{ v }}</li>
                                            {% endfor %}
                                            </ul>
                                        {% elif value is sequence and value is not string %}
                                            {{ value|join(', ') }}
                                        {% else %}
                                            {{ value }}
                                        {% endif %}
                                        </p>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if activity.data.load_dimensions %}
                                    <p><strong>Load Dimensions:</strong></p>
                                    <ul>
                                        {% for key, value in activity.data.load_dimensions.items() %}
                                        <li>{{ key.replace('_', ' ').title() }}: {{ value }}</li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No detailed service data available.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Actions History -->
            <div class="card">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Actions & Follow-ups</h5>
                    {% if lead.assigned_admin_id == current_user.id or session.is_super_admin %}
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addActionModal">
                        <i class="fas fa-plus"></i> Add Action
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if lead.actions %}
                        {% for action in lead.actions %}
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ action.action_type.replace('_', ' ').title() }}</strong>
                                    <span class="badge bg-secondary ms-2">{{ action.admin.contact_name or action.admin.company_name }}</span>
                                </div>
                                <small class="text-muted">{{ action.created_at.strftime('%m/%d/%Y %I:%M %p') }}</small>
                            </div>
                            <div class="card-body">
                                {% if action.subject %}
                                <p><strong>Subject:</strong> {{ action.subject }}</p>
                                {% endif %}
                                {% if action.description %}
                                <p><strong>Description:</strong> {{ action.description }}</p>
                                {% endif %}
                                {% if action.follow_up_date %}
                                <p><strong>Follow-up Date:</strong> 
                                    <span class="text-warning">
                                        <i class="fas fa-calendar"></i> {{ action.follow_up_date.strftime('%m/%d/%Y') }}
                                    </span>
                                </p>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                            <p>No actions recorded yet</p>
                            {% if lead.assigned_admin_id == current_user.id or session.is_super_admin %}
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addActionModal">
                                <i class="fas fa-plus"></i> Add First Action
                            </button>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    {% if lead.status == 'pending' and not lead.assigned_admin_id %}
                        <button class="btn btn-success w-100 mb-2 assign-lead-btn" 
                                data-lead-id="{{ lead.id }}" 
                                data-company="{{ lead.company.company_name }}">
                            <i class="fas fa-hand-paper"></i> Assign to Me
                        </button>
                    {% endif %}
                    
                    {% if session.is_super_admin and lead.status == 'pending' %}
                        <button class="btn btn-warning w-100 mb-2 reassign-lead-btn" 
                                data-lead-id="{{ lead.id }}" 
                                data-company="{{ lead.company.company_name }}">
                            <i class="fas fa-user-cog"></i> Assign to Other Admin
                        </button>
                    {% endif %}
                    
                    {% if (lead.assigned_admin_id == current_user.id or session.is_super_admin) and lead.status not in ['converted', 'lost'] %}
                        <button class="btn btn-success w-100 mb-2 convert-lead-btn"
                                data-lead-id="{{ lead.id }}"
                                data-company="{{ lead.company.company_name }}">
                            <i class="fas fa-check"></i> Mark as Converted
                        </button>
                        <button class="btn btn-danger w-100 mb-2 lost-lead-btn"
                                data-lead-id="{{ lead.id }}"
                                data-company="{{ lead.company.company_name }}">
                            <i class="fas fa-times"></i> Mark as Lost
                        </button>
                    {% endif %}

                    <a href="tel:{{ lead.company.phone_number }}" class="btn btn-outline-primary w-100 mb-2">
                        <i class="fas fa-phone"></i> Call {{ lead.company.phone_number or 'Company' }}
                    </a>
                    <a href="mailto:{{ lead.company.email }}" class="btn btn-outline-info w-100">
                        <i class="fas fa-envelope"></i> Email Company
                    </a>
                </div>
            </div>

            <!-- Lead Stats -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Lead Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-primary">{{ lead.actions|length }}</h4>
                            <small class="text-muted">Total Actions</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-warning">
                                {% set days_since = (current_datetime - lead.created_at).days %}
                                {{ days_since }}
                            </h4>
                            <small class="text-muted">Days Since Created</small>
                        </div>
                    </div>
                    <hr>
                    <div class="text-center">
                        <small class="text-muted">
                            Company registered: {{ lead.company.created_at.strftime('%m/%d/%Y') }}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Action Modal -->
<div class="modal fade" id="addActionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Sales Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addActionForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="action-type" class="form-label">Action Type</label>
                                <select class="form-select" id="action-type" name="action_type" required>
                                    <option value="">Select action type...</option>
                                    <option value="call">Phone Call</option>
                                    <option value="email">Email</option>
                                    <option value="text">Text Message</option>
                                    <option value="meeting">Meeting</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="follow-up-date" class="form-label">Follow-up Date (optional)</label>
                                <input type="date" class="form-control" id="follow-up-date" name="follow_up_date">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="subject" class="form-label">Subject <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="subject" name="subject" required
                               placeholder="Brief subject/title for this action...">
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="4" 
                                  placeholder="Detailed notes about the conversation, interest level, next steps, etc."></textarea>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="save-action-btn">
                    <i class="fas fa-save"></i> Save Action
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Include modals from the leads list page -->
<!-- Assign Lead Modal -->
<div class="modal fade" id="assignLeadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Lead to Myself</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to assign this lead to yourself?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirm-assign-btn">
                    <i class="fas fa-hand-paper"></i> Assign to Me
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Convert Lead Modal -->
<div class="modal fade" id="convertLeadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Convert Lead</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Mark this lead as converted:</p>
                <div class="mb-3">
                    <label for="conversion-value" class="form-label">Conversion Value ($)</label>
                    <input type="number" class="form-control" id="conversion-value" step="0.01" min="0">
                </div>
                <div class="mb-3">
                    <label for="conversion-notes" class="form-label">Notes</label>
                    <textarea class="form-control" id="conversion-notes" rows="3" placeholder="Details about the conversion..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirm-convert-btn">
                    <i class="fas fa-check"></i> Mark as Converted
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Lost Lead Modal -->
<div class="modal fade" id="lostLeadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Mark Lead as Lost</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Mark this lead as lost:</p>
                <div class="mb-3">
                    <label for="lost-reason" class="form-label">Reason (optional)</label>
                    <textarea class="form-control" id="lost-reason" rows="3" placeholder="Why was this lead lost?"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-lost-btn">
                    <i class="fas fa-times"></i> Mark as Lost
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reassign Lead Modal -->
<div class="modal fade" id="reassignLeadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Lead to Another Admin</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Select an admin to assign this lead to:</p>
                <div class="mb-3">
                    <label for="admin-select" class="form-label">Admin</label>
                    <select class="form-select" id="admin-select" required>
                        <option value="">Select an admin...</option>
                        {% for admin in admins %}
                            {% if admin.id != current_user.id %}
                                <option value="{{ admin.id }}">
                                    {{ admin.contact_name or admin.company_name }} 
                                    {% if admin.is_super_admin %}(Super Admin){% endif %}
                                </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirm-reassign-btn">
                    <i class="fas fa-user-cog"></i> Assign Lead
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const leadId = {{ lead.id }};

    // Add action functionality - SIMPLIFIED
    document.getElementById('save-action-btn').addEventListener('click', function(e) {
        e.preventDefault();
        
        const form = document.getElementById('addActionForm');
        const actionType = document.getElementById('action-type').value;
        const subject = document.getElementById('subject').value;
        const description = document.getElementById('description').value;
        const followUpDate = document.getElementById('follow-up-date').value;
        
        // Simple validation
        if (!actionType) {
            alert('Please select an action type');
            return;
        }
        if (!subject) {
            alert('Please enter a subject');
            return;
        }
        
        // Create form data manually
        const formData = new FormData();
        formData.append('action_type', actionType);
        formData.append('subject', subject);
        formData.append('description', description);
        formData.append('follow_up_date', followUpDate);

        // Submit form
        fetch('/admin/crm/add-action/' + leadId, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Action added successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error submitting form. Please try again.');
        });
    });

    // Assign lead functionality
    document.querySelectorAll('.assign-lead-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            new bootstrap.Modal(document.getElementById('assignLeadModal')).show();
        });
    });

    document.getElementById('confirm-assign-btn').addEventListener('click', function() {
        fetch(`/admin/crm/assign-lead/${leadId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'admin_id='
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        });
    });

    // Convert lead functionality
    document.querySelectorAll('.convert-lead-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            new bootstrap.Modal(document.getElementById('convertLeadModal')).show();
        });
    });

    document.getElementById('confirm-convert-btn').addEventListener('click', function() {
        const formData = new FormData();
        formData.append('conversion_value', document.getElementById('conversion-value').value);
        formData.append('conversion_notes', document.getElementById('conversion-notes').value);

        fetch(`/admin/crm/convert-lead/${leadId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        });
    });

    // Lost lead functionality
    document.querySelectorAll('.lost-lead-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            new bootstrap.Modal(document.getElementById('lostLeadModal')).show();
        });
    });

    document.getElementById('confirm-lost-btn').addEventListener('click', function() {
        const formData = new FormData();
        formData.append('lost_reason', document.getElementById('lost-reason').value);

        fetch(`/admin/crm/lost-lead/${leadId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        });
    });

    // Reassign lead functionality
    document.querySelectorAll('.reassign-lead-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            new bootstrap.Modal(document.getElementById('reassignLeadModal')).show();
        });
    });

    document.getElementById('confirm-reassign-btn').addEventListener('click', function() {
        const adminId = document.getElementById('admin-select').value;
        if (!adminId) {
            alert('Please select an admin to assign the lead to.');
            return;
        }

        fetch(`/admin/crm/assign-lead/${leadId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `admin_id=${adminId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        });
    });
});
</script>
{% endblock %} 