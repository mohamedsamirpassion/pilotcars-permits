{% extends "base.html" %}

{% block title %}Vendor Availability - My PEVO Admin{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-map-marker-alt me-2"></i>Vendor Availability</h2>
                    <p class="text-muted">View all active vendors and their locations from the last 48 hours.</p>
                </div>
                <div>
                    <a href="/admin" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left me-2"></i>Admin Dashboard
                    </a>
                    <a href="/admin/manage-users" class="btn btn-primary">
                        <i class="fas fa-users me-2"></i>Manage Users
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <!-- View Toggle -->
        <div class="col-12">
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="viewType" id="mapView" autocomplete="off" checked>
                <label class="btn btn-outline-primary" for="mapView">
                    <i class="fas fa-map me-2"></i>Map View
                </label>

                <input type="radio" class="btn-check" name="viewType" id="tableView" autocomplete="off">
                <label class="btn btn-outline-primary" for="tableView">
                    <i class="fas fa-table me-2"></i>Table View
                </label>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Map View -->
        <div class="col-lg-8" id="mapViewContainer">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-map me-2"></i>Vendor Location Map</h5>
                </div>
                <div class="card-body p-0">
                    <!-- Service Filters -->
                    <div class="p-3 border-bottom">
                        <h6 class="mb-2">Filter by Service</h6>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="filterChase" value="Chase/Lead" checked>
                            <label class="form-check-label" for="filterChase">Chase/Lead</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="filterHP" value="HP (Height Pole)" checked>
                            <label class="form-check-label" for="filterHP">HP (Height Pole)</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="filterSurvey" value="Route Survey" checked>
                            <label class="form-check-label" for="filterSurvey">Route Survey</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="filterSteer" value="Steer" checked>
                            <label class="form-check-label" for="filterSteer">Steer</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="showAllVendors" checked>
                            <label class="form-check-label" for="showAllVendors">Show All Vendors</label>
                        </div>
                    </div>

                    <div class="p-3 bg-light">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle text-primary me-2"></i>
                            <small>
                                <span class="badge bg-success me-1">Green pins</span> = registered vendors, 
                                <span class="badge bg-info me-1">Blue pins</span> = guest vendors
                            </small>
                        </div>
                    </div>

                    <div id="map" style="height: 600px; width: 100%;"></div>
                </div>
            </div>
        </div>

        <!-- Table View -->
        <div class="col-lg-12 d-none" id="tableViewContainer">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-table me-2"></i>Vendor Location List</h5>
                </div>
                <div class="card-body">
                    {% if locations %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Vendor</th>
                                        <th>Location</th>
                                        <th>Coverage</th>
                                        <th>Services</th>
                                        <th>Contact</th>
                                        <th>Shared On</th>
                                        <th>Expires</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for location in locations %}
                                        <tr>
                                            <td>
                                                <strong>{{ location.company_name }}</strong>
                                                {% if location.is_registered_vendor %}
                                                    <span class="badge bg-success ms-1">Registered</span>
                                                {% else %}
                                                    <span class="badge bg-info ms-1">Guest</span>
                                                {% endif %}
                                                {% if location.contact_name %}
                                                    <br><small class="text-muted">{{ location.contact_name }}</small>
                                                {% endif %}
                                            </td>
                                            <td>{{ location.location_city }}, {{ location.location_state }}</td>
                                            <td>{{ location.coverage_radius }} miles</td>
                                            <td>
                                                {% for service in location.services_provided %}
                                                    <span class="badge bg-secondary me-1">{{ service }}</span>
                                                {% endfor %}
                                            </td>
                                            <td>
                                                <div>
                                                    <a href="mailto:{{ location.email }}">{{ location.email }}</a><br>
                                                    <a href="tel:{{ location.phone }}">{{ location.phone }}</a>
                                                </div>
                                            </td>
                                            <td>{{ location.created_at }}</td>
                                            <td>{{ location.expires_at }}</td>
                                            <td>
                                                <span class="badge bg-success">Active</span>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Active Vendors</h5>
                            <p class="text-muted">No vendors have shared their locations in the last 48 hours.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Trip Assignment Search -->
        <div class="col-lg-4" id="searchContainer">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-search me-2"></i>Trip Assignment Search</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="searchLocation" class="form-label">Search Location</label>
                        <input type="text" class="form-control" id="searchLocation" 
                               placeholder="Dallas, TX" 
                               autocomplete="off">
                        <div class="form-text">Example: Dallas, TX</div>
                    </div>

                    <div class="mb-3">
                        <label for="searchRadius" class="form-label">Search Radius</label>
                        <select class="form-select" id="searchRadius">
                            <option value="50">50 miles</option>
                            <option value="100" selected>100 miles</option>
                            <option value="150">150 miles</option>
                            <option value="200">200 miles</option>
                            <option value="300">300 miles</option>
                        </select>
                    </div>

                    <button type="button" class="btn btn-primary w-100 mb-3" id="searchBtn">
                        <i class="fas fa-search me-2"></i>Search Vendors
                    </button>

                    <div class="text-center mb-3">
                        <small class="text-muted">Or place a pin on the map</small>
                    </div>

                    <button type="button" class="btn btn-outline-warning w-100 mb-3" id="enablePinMode">
                        <i class="fas fa-map-pin me-2"></i>Enable Pin Placement Mode
                    </button>

                    <div class="alert alert-info d-none" id="pinModeAlert">
                        <i class="fas fa-mouse-pointer me-2"></i>
                        <small>Click the button above, then click anywhere on the map to place a pin</small>
                    </div>

                    <!-- Search Results -->
                    <div id="searchResults" class="mt-4"></div>
                </div>
            </div>

            <!-- Outside Coverage Area -->
            <div class="card mt-4">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Outside Coverage Area</h6>
                </div>
                <div class="card-body">
                    <div id="outsideCoverageVendors">
                        {% for location in locations %}
                            <div class="vendor-card mb-3 p-3 border rounded">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ location.company_name }}
                                            {% if location.is_registered_vendor %}
                                                <span class="badge bg-success ms-1">Registered</span>
                                            {% else %}
                                                <span class="badge bg-info ms-1">Out of Range</span>
                                            {% endif %}
                                        </h6>
                                        <p class="text-muted mb-1">{{ location.location_city }}, {{ location.location_state }}</p>
                                        <p class="text-muted mb-2">Coverage: {{ location.coverage_radius }} miles</p>
                                        <div class="mb-2">
                                            <small><strong>Services:</strong></small>
                                            {% for service in location.services_provided %}
                                                <span class="badge bg-light text-dark me-1">{{ service }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="btn-group-vertical" role="group">
                                            <a href="tel:{{ location.phone }}" class="btn btn-sm btn-outline-success">
                                                <i class="fas fa-phone"></i> Call
                                            </a>
                                            <a href="mailto:{{ location.email }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-envelope"></i> Email
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-info me-2" onclick="viewVendorInfo({{ location.id }})">
                                        <i class="fas fa-info-circle me-1"></i>View Info
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="assignVendor({{ location.id }})">
                                        <i class="fas fa-check me-1"></i>Assign
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let map;
let markers = [];
let searchMarker = null;
let searchCircle = null;
let pinPlacementMode = false;
let locations = {{ locations | tojson }};

function initMap() {
    // Initialize map centered on US
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 4,
        center: { lat: 39.8283, lng: -98.5795 }, // Center of US
        mapTypeId: 'roadmap'
    });

    // Add click listener for pin placement
    map.addListener('click', function(event) {
        if (pinPlacementMode) {
            placeSearchPin(event.latLng);
            pinPlacementMode = false;
            document.getElementById('enablePinMode').classList.remove('btn-warning');
            document.getElementById('enablePinMode').classList.add('btn-outline-warning');
            document.getElementById('pinModeAlert').classList.add('d-none');
        }
    });

    // Load vendor locations
    loadVendorMarkers();
}

function loadVendorMarkers() {
    // Clear existing markers
    markers.forEach(marker => marker.setMap(null));
    markers = [];

    // Get selected services
    const selectedServices = [];
    document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
        if (checkbox.id !== 'showAllVendors') {
            selectedServices.push(checkbox.value);
        }
    });

    const showAll = document.getElementById('showAllVendors').checked;

    locations.forEach(location => {
        // Check if vendor should be shown based on service filters
        let shouldShow = showAll;
        if (!showAll && selectedServices.length > 0) {
            shouldShow = selectedServices.some(service => location.services_provided.includes(service));
        }

        if (shouldShow && location.latitude && location.longitude) {
            const position = {
                lat: parseFloat(location.latitude),
                lng: parseFloat(location.longitude)
            };

            const icon = location.is_registered_vendor ? 
                'https://maps.google.com/mapfiles/ms/icons/green-dot.png' :
                'https://maps.google.com/mapfiles/ms/icons/blue-dot.png';

            const marker = new google.maps.Marker({
                position: position,
                map: map,
                title: location.company_name,
                icon: icon
            });

            // Create info window
            const infoContent = `
                <div style="max-width: 300px;">
                    <h6>${location.company_name} ${location.is_registered_vendor ? '<span class="badge bg-success">Registered</span>' : '<span class="badge bg-info">Guest</span>'}</h6>
                    <p><strong>Location:</strong> ${location.location_city}, ${location.location_state}</p>
                    <p><strong>Coverage:</strong> ${location.coverage_radius} miles</p>
                    <p><strong>Services:</strong><br>
                        ${location.services_provided.map(service => 
                            `<span class="badge bg-secondary me-1">${service}</span>`
                        ).join('')}
                    </p>
                    <p><strong>Contact:</strong><br>
                        <a href="tel:${location.phone}">${location.phone}</a><br>
                        <a href="mailto:${location.email}">${location.email}</a>
                    </p>
                    ${location.notes ? `<p><strong>Notes:</strong> ${location.notes}</p>` : ''}
                    <div class="mt-2">
                        <button class="btn btn-sm btn-success" onclick="assignVendor(${location.id})">
                            <i class="fas fa-check me-1"></i>Assign
                        </button>
                    </div>
                </div>
            `;

            const infoWindow = new google.maps.InfoWindow({
                content: infoContent
            });

            marker.addListener('click', () => {
                // Close all other info windows
                markers.forEach(m => {
                    if (m.infoWindow) m.infoWindow.close();
                });
                infoWindow.open(map, marker);
            });

            marker.infoWindow = infoWindow;
            markers.push(marker);
        }
    });
}

function placeSearchPin(latLng) {
    // Remove existing search marker and circle
    if (searchMarker) searchMarker.setMap(null);
    if (searchCircle) searchCircle.setMap(null);

    // Place new search marker
    searchMarker = new google.maps.Marker({
        position: latLng,
        map: map,
        title: 'Search Location',
        icon: 'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png'
    });

    // Add search radius circle
    const radius = parseInt(document.getElementById('searchRadius').value) * 1609.34; // Convert miles to meters
    searchCircle = new google.maps.Circle({
        strokeColor: '#FF0000',
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: '#FF0000',
        fillOpacity: 0.15,
        map: map,
        center: latLng,
        radius: radius
    });

    // Reverse geocode to get address
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ location: latLng }, (results, status) => {
        if (status === 'OK' && results[0]) {
            document.getElementById('searchLocation').value = results[0].formatted_address;
        }
    });

    // Search for nearby vendors
    searchNearbyVendors(latLng.lat(), latLng.lng());
}

function searchNearbyVendors(lat, lng) {
    const radius = parseInt(document.getElementById('searchRadius').value);
    
    fetch('/admin/search-vendors', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            location: document.getElementById('searchLocation').value,
            latitude: lat,
            longitude: lng,
            radius: radius
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displaySearchResults(data.vendors);
        } else {
            alert('Error searching vendors: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error searching vendors');
    });
}

function displaySearchResults(vendors) {
    const resultsContainer = document.getElementById('searchResults');
    
    if (vendors.length === 0) {
        resultsContainer.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                No vendors found within the specified radius.
            </div>
        `;
        return;
    }

    let html = `
        <div class="alert alert-success">
            <i class="fas fa-check-circle me-2"></i>
            Found ${vendors.length} vendor(s) within ${document.getElementById('searchRadius').value} miles
        </div>
    `;

    vendors.forEach(vendor => {
        html += `
            <div class="vendor-result mb-3 p-3 border rounded">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6>${vendor.company_name} 
                            ${vendor.is_registered ? '<span class="badge bg-success">Registered</span>' : '<span class="badge bg-info">Guest</span>'}
                            ${vendor.distance !== null ? `<span class="badge bg-primary">${vendor.distance} mi</span>` : ''}
                        </h6>
                        <p class="text-muted mb-1">${vendor.location}</p>
                        <p class="text-muted mb-2">Coverage: ${vendor.coverage_radius} miles</p>
                        <div class="mb-2">
                            <small><strong>Services:</strong></small>
                            ${vendor.services.map(service => 
                                `<span class="badge bg-secondary me-1">${service}</span>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="btn-group-vertical" role="group">
                            <a href="tel:${vendor.phone}" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-phone"></i> Call
                            </a>
                            <a href="mailto:${vendor.email}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-envelope"></i> Email
                            </a>
                        </div>
                    </div>
                </div>
                <div class="mt-2">
                    <button class="btn btn-sm btn-info me-2" onclick="viewVendorInfo(${vendor.id})">
                        <i class="fas fa-info-circle me-1"></i>View Info
                    </button>
                    <button class="btn btn-sm btn-success" onclick="assignVendor(${vendor.id})">
                        <i class="fas fa-check me-1"></i>Assign
                    </button>
                </div>
            </div>
        `;
    });

    resultsContainer.innerHTML = html;
}

function viewVendorInfo(vendorId) {
    // Implementation for viewing detailed vendor info
    alert('View vendor info functionality - to be implemented');
}

function assignVendor(vendorId) {
    // Implementation for assigning vendor to trip
    alert('Assign vendor functionality - to be implemented');
}

// Event listeners
document.getElementById('mapView').addEventListener('change', function() {
    if (this.checked) {
        document.getElementById('mapViewContainer').classList.remove('d-none');
        document.getElementById('searchContainer').classList.remove('d-none');
        document.getElementById('tableViewContainer').classList.add('d-none');
        google.maps.event.trigger(map, 'resize');
    }
});

document.getElementById('tableView').addEventListener('change', function() {
    if (this.checked) {
        document.getElementById('mapViewContainer').classList.add('d-none');
        document.getElementById('searchContainer').classList.add('d-none');
        document.getElementById('tableViewContainer').classList.remove('d-none');
    }
});

document.getElementById('enablePinMode').addEventListener('click', function() {
    pinPlacementMode = true;
    this.classList.remove('btn-outline-warning');
    this.classList.add('btn-warning');
    document.getElementById('pinModeAlert').classList.remove('d-none');
});

document.getElementById('searchBtn').addEventListener('click', function() {
    const location = document.getElementById('searchLocation').value;
    if (!location) {
        alert('Please enter a search location');
        return;
    }

    // Geocode the location
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ address: location }, (results, status) => {
        if (status === 'OK') {
            const latLng = results[0].geometry.location;
            map.setCenter(latLng);
            map.setZoom(10);
            placeSearchPin(latLng);
        } else {
            alert('Could not find location: ' + location);
        }
    });
});

// Service filter event listeners
document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', loadVendorMarkers);
});

// Initialize autocomplete for search location
function initAutocomplete() {
    const autocomplete = new google.maps.places.Autocomplete(
        document.getElementById('searchLocation'),
        { types: ['geocode'] }
    );
}
</script>

<!-- Google Maps API with Places -->
<script async defer 
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB7POzdvk3ri7buWrkOLV7nNZK8pSeOxao&libraries=places&callback=initMap">
</script>
{% endblock %} 